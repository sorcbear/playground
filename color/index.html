<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Color Scratch (Palette + P reveal)</title>
  <style>
    :root{
      --maxw: 980px;
      --pad: 18px;
      --radius: 10px;
      --bg: #fff;
      --text:#111;
      --border:#000;

      --swatch: 44px;         /* 调色盘色块大小 */
      --swatch-gap: 14px;     /* 色块间距 */
      --swatch-ring: 3px;     /* 选中描边粗细 */

      --hint-fs: 14px;
      --hint-lh: 1.6;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial, sans-serif;
    }

    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: var(--pad);
    }

    .stage{
      position: relative;
      width: 100%;
      border-radius: var(--radius);
      overflow: hidden;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none; /* 移动端拖动不滚屏 */
      background:#eee;
    }

    .stage img{ width:100%; display:block; }

    canvas.overlay{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      pointer-events:auto;
    }

    .loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(2px);
    }
    .loading.hide{ display:none; }

    /* 调色盘 */
    .paletteWrap{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      align-items:center;
    }

    .palette{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap: var(--swatch-gap);
    }

    .swatch{
      width: var(--swatch);
      height: var(--swatch);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.25);
      background: var(--c);
      cursor: pointer;
      position: relative;
      padding:0;
      outline:none;
      -webkit-tap-highlight-color: transparent;
    }

    /* 选中样式：黑色外圈 + 白色内圈（更像“被框住”） */
    .swatch.selected{
      border-color: var(--border);
      box-shadow:
        0 0 0 var(--swatch-ring) #000,
        0 0 0 calc(var(--swatch-ring) + 3px) #fff;
    }

    /* 可选：选中小点提示 */
    .swatch.selected::after{
      content:"";
      position:absolute;
      right: 6px;
      bottom: 6px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background:#fff;
      border:2px solid #000;
    }

    .hint{
      font-size: var(--hint-fs);
      line-height: var(--hint-lh);
      opacity:.78;
      text-align:center;
    }

    .hint strong{ opacity:1; }

    @media (max-width: 420px){
      :root{
        --swatch: 40px;
        --swatch-gap: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="stage" id="stage">
      <img id="bw" src="bw.jpg" alt="bw" />
      <canvas id="paint" class="overlay"></canvas>
      <div id="loading" class="loading">资源加载中</div>
    </div>

    <div class="paletteWrap">
      <div class="palette" id="palette"></div>
      <div class="hint" id="hint">
        请先选择一种颜色，然后在画面上涂抹。<br/>
        <strong>只有选中正确的红色，才会显示隐藏的 P。</strong>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== 可调参数 =====
  const BRUSH_RADIUS_CSSPX = 18;         // 画笔半径（CSS像素）
  const BASE_MASK_URL = "mask_base.png"; // 透明基础蒙版（avec toi 白框/文字）
  const CORRECT_RED = "#ff0000";         // ✅ 只有选中这个红色才启用 P 挖洞

  // 8 色调色盘（你可自行替换颜色）
  const COLORS = [
    "#000000", // 黑
    "#00e5ff", // 青
    CORRECT_RED, // 正确红（必须保留）
    "#ffc000", // 橙黄
    "#00b050", // 绿
    "#7030a0", // 紫
    "#ffffff", // 白
    "#0070c0"  // 蓝
  ];
  // ====================

  const img = document.getElementById("bw");
  const cv = document.getElementById("paint");
  const loading = document.getElementById("loading");
  const paletteEl = document.getElementById("palette");
  const hintEl = document.getElementById("hint");

  const ctx = cv.getContext("2d", { alpha:true });

  // 离屏：基础 mask（始终挖洞）
  const baseMaskCanvas = document.createElement("canvas");
  const baseMaskCtx = baseMaskCanvas.getContext("2d");

  const baseMaskImg = new Image();
  baseMaskImg.decoding = "async";
  baseMaskImg.src = BASE_MASK_URL;

  // 离屏：P mask（仅在正确红色时挖洞）
  const pMaskCanvas = document.createElement("canvas");
  const pMaskCtx = pMaskCanvas.getContext("2d");

  // 当前选中颜色（必须先选）
  let currentColor = null;

  // 设备像素比（保证清晰、触点对齐）
  function dpr(){ return Math.max(1, Math.min(3, window.devicePixelRatio || 1)); }

  // ====== 画 P（白色笔画绘制在 pMaskCanvas 上）======
  function rebuildPMask(){
    const w = pMaskCanvas.width;
    const h = pMaskCanvas.height;

    pMaskCtx.setTransform(1,0,0,1,0,0);
    pMaskCtx.clearRect(0,0,w,h);

    // 你可以通过调这些比例改变 P 位置与大小
    const cx = w * 0.58;
    const cy = h * 0.58;
    const s  = Math.min(w/1200, h/800) * 1.0; // 整体缩放
    const strokeW = Math.max(36, Math.round(58 * (w/1200)));

    const p = new Path2D();

    // 主竖（带一点手写弧度）
    p.moveTo(cx + (-40)*s, cy + (-220)*s);
    p.quadraticCurveTo(cx + (-60)*s, cy + (-80)*s,  cx + (-40)*s, cy + (80)*s);
    p.quadraticCurveTo(cx + (-30)*s, cy + (160)*s,  cx + (-40)*s, cy + (240)*s);

    // 上半圆肚
    p.moveTo(cx + (-40)*s, cy + (-200)*s);
    p.quadraticCurveTo(cx + (90)*s,  cy + (-215)*s, cx + (150)*s, cy + (-160)*s);
    p.quadraticCurveTo(cx + (210)*s, cy + (-120)*s, cx + (195)*s, cy + (-50)*s);
    p.quadraticCurveTo(cx + (175)*s, cy + (25)*s,   cx + (95)*s,  cy + (55)*s);
    p.quadraticCurveTo(cx + (25)*s,  cy + (80)*s,   cx + (-40)*s, cy + (65)*s);

    pMaskCtx.save();
    pMaskCtx.strokeStyle = "white";
    pMaskCtx.lineWidth = strokeW;
    pMaskCtx.lineCap = "round";
    pMaskCtx.lineJoin = "round";
    pMaskCtx.stroke(p);
    pMaskCtx.restore();
  }

  // ====== 尺寸对齐：canvas + 两个离屏 mask ======
  function resizeAll(){
    const rect = img.getBoundingClientRect();
    const scale = dpr();

    // 可见涂抹层：按 CSS 像素绘制
    cv.width  = Math.round(rect.width  * scale);
    cv.height = Math.round(rect.height * scale);
    ctx.setTransform(scale,0,0,scale,0,0);

    // 基础 mask：像素坐标
    baseMaskCanvas.width  = cv.width;
    baseMaskCanvas.height = cv.height;

    // P mask：像素坐标
    pMaskCanvas.width  = cv.width;
    pMaskCanvas.height = cv.height;

    // 重建两类 mask
    baseMaskCtx.setTransform(1,0,0,1,0,0);
    baseMaskCtx.clearRect(0,0,baseMaskCanvas.width, baseMaskCanvas.height);
    baseMaskCtx.drawImage(baseMaskImg, 0, 0, baseMaskCanvas.width, baseMaskCanvas.height);

    rebuildPMask();
  }

  // ====== 挖洞：基础蒙版始终挖；P 仅在选中正确红时挖 ======
  function punchOutMasks(){
    const w = cv.width, h = cv.height;

    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.globalCompositeOperation = "destination-out";

    // 1) 基础蒙版始终挖洞（白框/白字区域永远透出底图）
    ctx.drawImage(baseMaskCanvas, 0, 0, w, h);

    // 2) 只有选中正确红，才挖出 P
    if (currentColor && currentColor.toLowerCase() === CORRECT_RED) {
      ctx.drawImage(pMaskCanvas, 0, 0, w, h);
    }

    ctx.restore();
  }

  // ====== 绘制：纯色不透明 ======
  function dab(x, y){
    ctx.save();
    ctx.globalCompositeOperation = "source-over";
    ctx.fillStyle = currentColor; // 纯色
    ctx.beginPath();
    ctx.arc(x, y, BRUSH_RADIUS_CSSPX, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // 每次画完立即抠洞
    punchOutMasks();
  }

  function strokeLine(x0,y0,x1,y1){
    const dx = x1-x0, dy = y1-y0;
    const dist = Math.hypot(dx,dy);
    const step = Math.max(2, BRUSH_RADIUS_CSSPX * 0.5);
    const n = Math.max(1, Math.ceil(dist / step));
    for(let i=1;i<=n;i++){
      const t = i/n;
      dab(x0 + dx*t, y0 + dy*t);
    }
  }

  function getXY(e){
    const r = cv.getBoundingClientRect();
    const p = (e.touches && e.touches[0]) || (e.changedTouches && e.changedTouches[0]) || e;
    return { x: p.clientX - r.left, y: p.clientY - r.top };
  }

  let down = false, last = null;

  function warnNeedColor(){
    // 轻量提示：不弹窗，不打断
    hintEl.innerHTML = '请先在下方<strong>选择一种颜色</strong>，再开始涂抹。<br/><strong>只有正确红色才会显示隐藏的 P。</strong>';
  }

  function onDown(e){
    e.preventDefault();
    if(!currentColor){ warnNeedColor(); return; }

    down = true;
    const p = getXY(e);
    last = p;
    dab(p.x, p.y);
  }
  function onMove(e){
    if(!down) return;
    e.preventDefault();
    const p = getXY(e);
    if(last) strokeLine(last.x, last.y, p.x, p.y);
    last = p;
  }
  function onUp(e){
    if(!down) return;
    e.preventDefault();
    down = false;
    last = null;
  }

  // ====== 事件绑定 ======
  cv.addEventListener("pointerdown", onDown, { passive:false });
  window.addEventListener("pointermove", onMove, { passive:false });
  window.addEventListener("pointerup", onUp, { passive:false });
  window.addEventListener("pointercancel", onUp, { passive:false });

  // touch fallback
  cv.addEventListener("touchstart", onDown, { passive:false });
  window.addEventListener("touchmove", onMove, { passive:false });
  window.addEventListener("touchend", onUp, { passive:false });
  window.addEventListener("touchcancel", onUp, { passive:false });

  // ====== 调色盘 UI ======
  function renderPalette(){
    paletteEl.innerHTML = "";
    COLORS.forEach((c, idx) => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "swatch";
      b.style.setProperty("--c", c);
      b.setAttribute("aria-label", "color " + c);

      b.addEventListener("click", () => {
        // 设为当前色
        currentColor = c;

        // 更新选中样式
        [...paletteEl.querySelectorAll(".swatch")].forEach(x => x.classList.remove("selected"));
        b.classList.add("selected");

        // 文案（可选）
        if (c.toLowerCase() === CORRECT_RED) {
          hintEl.innerHTML = '已选中<strong>正确红色</strong>：现在涂抹将显示隐藏的 P。';
        } else {
          hintEl.innerHTML = '已选中颜色：可以涂抹。但<strong>只有正确红色</strong>才会显示隐藏的 P。';
        }
      });

      // 默认不选中任何颜色（必须先点）
      paletteEl.appendChild(b);
    });
  }

  // ====== 资源加载 ======
  function ready(){
    resizeAll();
    renderPalette();
    loading.classList.add("hide");
  }

  let imgOK = false, baseMaskOK = false;

  img.addEventListener("load", () => { imgOK = true; if(baseMaskOK) ready(); });
  img.addEventListener("error", () => { loading.textContent = "底图 bw.jpg 加载失败"; });

  baseMaskImg.addEventListener("load", () => { baseMaskOK = true; if(imgOK) ready(); });
  baseMaskImg.addEventListener("error", () => { loading.textContent = "蒙版 mask_base.png 加载失败"; });

  // 旋转/缩放会重置 canvas（涂层会清空）
  window.addEventListener("resize", () => {
    if(imgOK && baseMaskOK) resizeAll();
  });
})();
</script>
</body>
</html>
