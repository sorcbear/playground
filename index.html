<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* ===== 全项目尺寸规范（index/验证页）===== */
      --maxw: 720px;
      --w-panel: 360px;     /* 输入框 + 双按钮统一宽 */
      --w-mainbtn: 240px;   /* 主按钮宽 */

      --fs-body: 16px;
      --fs-hint: 18px;
      --fs-status: 18px;

      --lh-body: 1.7;
      --lh-hint: 1.6;

      --fw-status: 700;

      --ctl-h: 48px;

      --gap: 18px;
      --gap-tight: 12px;

      --c-text: #111;
      --c-danger: #b00020;
      --c-border: #000;
    }

    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      font-size:var(--fs-body);
      line-height:var(--lh-body);
      color:var(--c-text);
    }
    button, input{ font-family: inherit; }

    /* ✅ 三段式：顶部信息区 / 中间居中区 / 底部对称留白
       解决“验证页偏下”的根因（视觉居中 vs 数学居中）。 */
    .container{
      width:100%;
      min-height:100svh;
      display:grid;
      grid-template-rows: auto 1fr 1fr;
      padding:18px;
      box-sizing:border-box;
      text-align:center;
    }

    /* 顶部信息区：固定高度，避免不同 phase 高度变化导致跳动 */
    .top{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:var(--gap-tight);
      padding-top:6px;
    }

    .hint{
      width:min(var(--maxw), 92vw);
      height:72px; /* 容纳两行提示 */
      font-size:var(--fs-hint);
      line-height:var(--lh-hint);
      white-space:pre-wrap;
      user-select:none;
      margin:0;

      display:flex;
      align-items:center;
      justify-content:center;
    }

    .status{
      width:min(var(--maxw), 92vw);
      height:28px;
      font-size:var(--fs-status);
      font-weight:var(--fw-status);
      letter-spacing:0;
      user-select:none;
      margin:0;

      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* 中间主操作区：真正居中（无论顶部有没有文字） */
    .center{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:var(--gap);
    }

    /* 底部占位（不放内容，仅用于对称留白） */
    .bottom{
      /* 空即可 */
    }

    /* ===== 输入面板 ===== */
    .panel{
      width:min(var(--maxw), 92vw);
      display:none;
      flex-direction:column;
      gap:var(--gap-tight);
      align-items:center;
    }

    .panel .label{
      width:min(var(--w-panel), 92vw);
      font-size:var(--fs-hint);
      line-height:var(--lh-hint);
      user-select:none;
      margin:0;
    }

    .panel input{
      width:min(var(--w-panel), 92vw);
      height:var(--ctl-h);
      padding:0 14px;
      box-sizing:border-box;
      font-size:var(--fs-body);
      border:2px solid var(--c-border);
      border-radius:12px;
      outline:none;
      text-transform:uppercase;
      letter-spacing:0;
    }

    .row{
      width:min(var(--w-panel), 92vw);
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:center;
      margin-top:2px;
    }

    button{
      height:var(--ctl-h);
      padding:0 18px;
      box-sizing:border-box;
      font-size:var(--fs-body);
      font-weight:600;
      letter-spacing:0;
      background:#fff;
      color:#000;
      border:2px solid var(--c-border);
      cursor:pointer;
      border-radius:0;
    }
    button:hover{ background:#000; color:#fff; }
    button:disabled{ opacity:.45; cursor:default; }

    .row button{ flex:1; }

    .err{
      width:min(var(--w-panel), 92vw);
      height:20px;        /* 固定高度，避免出现错误时整体位移 */
      font-size:14px;
      line-height:20px;
      color:var(--c-danger);
      user-select:none;
      text-align:center;
      margin:0;
    }

    /* ===== 主按钮 ===== */
    .mainWrap{
      display:flex;
      justify-content:center;
      width:min(var(--maxw), 92vw);
    }
    #mainBtn{ width:var(--w-mainbtn); }

    @media (max-width: 420px){
      :root{
        --w-panel: 320px;
        --w-mainbtn: 220px;
        --ctl-h: 46px;
        --fs-hint: 17px;
        --fs-status: 17px;
      }
      .hint{ height:68px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 顶部信息区 -->
    <div class="top">
      <div class="hint" id="hint"></div>
      <div class="status" id="status"></div>
    </div>

    <!-- 中间主操作区（真正居中） -->
    <div class="center">
      <div class="panel" id="panel">
        <div class="label">请输入游戏码</div>
        <input id="codeInput" placeholder="XXXX-XXXX" autocomplete="off" inputmode="latin" />
        <div class="row">
          <button id="verifyBtn">验证</button>
          <button id="cancelBtn">取消</button>
        </div>
        <div class="err" id="err"></div>
      </div>

      <div class="mainWrap" id="mainWrap">
        <button id="mainBtn">确定</button>
      </div>
    </div>

    <!-- 底部对称留白（空） -->
    <div class="bottom"></div>
  </div>

<script>
(() => {
  const VERIFY_ENDPOINT = "https://1396901144-84o46m5fmk.ap-shanghai.tencentscf.com/verify";
  const PASS_KEY = "playground_pass_v1";
  const NEXT_URL = "./start.html";

  // reset=1：清通行证，强制回到输入码流程
  const params = new URLSearchParams(location.search);
  if (params.get("reset") === "1") {
    localStorage.removeItem(PASS_KEY);
  }

  function setPass(){
    const token = "pass_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem(PASS_KEY, token);
  }
  function hasPass(){ return !!localStorage.getItem(PASS_KEY); }

  // 已验证：直接去 start 页
  if (hasPass()) {
    location.replace(NEXT_URL);
    return;
  }

  function normalizeCode(s){
    return String(s || "")
      .trim()
      .toUpperCase()
      .replace(/\s+/g, "")
      .replace(/—/g, "-")
      .replace(/–/g, "-");
  }

  async function verifyCode(code){
    const r = await fetch(VERIFY_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code }),
    });
    const data = await r.json().catch(() => ({}));
    return { httpOk: r.ok, data };
  }

  // DOM
  const hintEl    = document.getElementById("hint");
  const statusEl  = document.getElementById("status");

  const panel     = document.getElementById("panel");
  const codeInput = document.getElementById("codeInput");
  const verifyBtn = document.getElementById("verifyBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const errEl     = document.getElementById("err");

  const mainWrap  = document.getElementById("mainWrap");
  const mainBtn   = document.getElementById("mainBtn");

  // phase:
  // 0: 确认页
  // 1: 输入码页
  // 2: 验证成功过渡(1秒)
  let phase = 0;
  let timers = [];

  function clearTimers(){
    timers.forEach(id => clearTimeout(id));
    timers = [];
  }
  function schedule(fn, ms){
    const id = setTimeout(fn, ms);
    timers.push(id);
    return id;
  }

  function showPanel(show){ panel.style.display = show ? "flex" : "none"; }
  function showMain(show){ mainWrap.style.display = show ? "flex" : "none"; }
  function setError(msg){ errEl.textContent = msg || ""; }

  function render(){
    if(phase === 0){
      showPanel(false);
      showMain(true);
      mainBtn.disabled = false;
      hintEl.textContent = "确定要玩这个游戏吗？\n这可能影响你和其他人的命运......";
      statusEl.textContent = "";
      setError("");
      return;
    }

    if(phase === 1){
      showPanel(true);
      showMain(false);
      hintEl.textContent = "";
      statusEl.textContent = "";
      setError("");
      return;
    }

    if(phase === 2){
      showPanel(false);
      showMain(false);
      hintEl.textContent = "";
      statusEl.textContent = "验证成功";
      setError("");
      return;
    }
  }

  async function doVerify(){
    const code = normalizeCode(codeInput.value);
    if(!code){
      setError("请输入游戏码");
      return;
    }

    verifyBtn.disabled = true;
    cancelBtn.disabled = true;
    setError("");
    statusEl.textContent = "验证中...";

    try{
      const { httpOk, data } = await verifyCode(code);
      const ok = !!data.ok;
      const reason = String(data.reason || "");

      if(ok && reason === "verified"){
        setPass();

        phase = 2;
        clearTimers();
        render();

        schedule(() => {
          location.href = NEXT_URL;
        }, 1000);

        return;
      }

      if(!ok && reason === "already_used"){
        statusEl.textContent = "";
        setError("该游戏码已被使用");
        return;
      }

      if(!ok && reason === "not_found"){
        statusEl.textContent = "";
        setError("游戏码不存在");
        return;
      }

      statusEl.textContent = "";
      const msg = data.message ? String(data.message) : (httpOk ? "验证失败" : "网络错误");
      setError(msg);
    }catch(e){
      statusEl.textContent = "";
      setError("网络错误，请重试");
    }finally{
      verifyBtn.disabled = false;
      cancelBtn.disabled = false;

      // 防止某些浏览器 focus 造成滚动：尽量不滚动
      try{ codeInput.focus({ preventScroll: true }); }catch(e){ codeInput.focus(); }
      codeInput.select();
    }
  }

  function enterCodePhase(){
    phase = 1;
    clearTimers();
    render();

    // 进入输入码页：避免浏览器自动滚动扰动视觉
    requestAnimationFrame(() => {
      window.scrollTo(0, 0);
      setTimeout(() => {
        try{ codeInput.focus({ preventScroll: true }); }catch(e){ codeInput.focus(); }
        window.scrollTo(0, 0);
      }, 50);
    });
  }

  // 事件
  mainBtn.addEventListener("click", () => {
    if(phase === 0) enterCodePhase();
  });

  cancelBtn.addEventListener("click", () => {
    phase = 0;
    clearTimers();
    render();
    window.scrollTo(0, 0);
  });

  verifyBtn.addEventListener("click", doVerify);
  codeInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") doVerify();
  });

  render();
})();
</script>
</body>
</html>
