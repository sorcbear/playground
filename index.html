<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circle Puzzle</title>
  <style>
    :root { --maxw: 720px; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif; background:#fff; color:#111; }
    .wrap{ max-width:var(--maxw); margin:0 auto; padding:12px; }
    .stage{ width:100%; aspect-ratio:918/1024; border-radius:10px; overflow:hidden; background:#fff; touch-action:manipulation; user-select:none; }
    svg{ width:100%; height:100%; display:block; }

    /* 透明点击层（真正负责响应点击） */
    .hit{ fill:rgba(0,0,0,0); stroke:rgba(0,0,0,0); pointer-events:all; cursor:pointer; }

    /* 红点层：默认透明，选中才显示 */
    .dot{ fill:rgba(220,0,0,0); pointer-events:none; }
    .hit.selected + .dot{ fill:rgba(220,0,0,0.92); }

    .panel{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap; }
    button{ appearance:none; border:0; background:#111; color:#fff; padding:12px 16px; border-radius:10px; font-size:16px; font-weight:700; }
    button:active{ transform:translateY(1px); }
    .msg{ flex:1; min-width:220px; padding:10px 12px; border-radius:10px; background:#f5f5f5; font-size:14px; line-height:1.35; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <svg viewBox="0 0 918 1024" preserveAspectRatio="xMidYMid meet" id="svg"
           xmlns="http://www.w3.org/2000/svg"
           xmlns:xlink="http://www.w3.org/1999/xlink">
        <image id="bg" href="map.png" xlink:href="map.png"
               x="0" y="0" width="918" height="1024"
               preserveAspectRatio="xMidYMid meet"
               style="pointer-events:none;"></image>

        <!-- 捕获整图点击，用“吸附到最近圆”来切换选择 -->
        <rect id="catcher" x="0" y="0" width="918" height="1024" fill="rgba(0,0,0,0)"></rect>
      </svg>
    </div>

    <div class="panel">
      <button id="submitBtn">Submit</button>
      <div class="msg" id="msg">点击空心圆选择/取消，然后 Submit。</div>
    </div>
  </div>

<script>
/**
 * 你的圆心坐标（46个）
 * 顺序即为内部编号 1..46（不显示给用户）
 */
const CIRCLES = [{"x":678,"y":84},{"x":752,"y":88},{"x":376,"y":166},{"x":473,"y":196},{"x":553,"y":171},{"x":657,"y":219},{"x":307,"y":263},{"x":886,"y":187},{"x":444,"y":247},{"x":115,"y":274},{"x":256,"y":209},{"x":806,"y":211},{"x":879,"y":318},{"x":217,"y":346},{"x":303,"y":346},{"x":547,"y":349},{"x":267,"y":638},{"x":105,"y":346},{"x":78,"y":434},{"x":56,"y":541},{"x":189,"y":548},{"x":164,"y":460},{"x":585,"y":491},{"x":438,"y":491},{"x":369,"y":579},{"x":813,"y":847},{"x":274,"y":550},{"x":485,"y":431},{"x":617,"y":305},{"x":608,"y":617},{"x":535,"y":573},{"x":839,"y":590},{"x":825,"y":659},{"x":897,"y":421},{"x":390,"y":673},{"x":303,"y":718},{"x":527,"y":663},{"x":486,"y":728},{"x":862,"y":744},{"x":730,"y":172},{"x":644,"y":827},{"x":506,"y":865},{"x":433,"y":878},{"x":332,"y":893},{"x":206,"y":774},{"x":186,"y":622}];

/**
 * 正确答案（内部编号 1-based，不显示）
 * 你如果还是用之前那套答案就保持不变；
 * 如果你根据新编号顺序变了，就在这里改。
 */
const ANSWER_NUMS = [3,17,18,22,28,35,38,42,45]; // 这里可改

/**
 * 红点“填满”的半径（统一）
 * 你觉得太大/太小就改 14~18
 */
const R_DOT = 15;

/**
 * 吸附距离：你点在圆附近也能命中
 * 你觉得还是难点就把 28 调到 32/36
 */
const SNAP_DIST = 30;

const svg = document.getElementById("svg");
const bg  = document.getElementById("bg");
const catcher = document.getElementById("catcher");
const msg = document.getElementById("msg");
const submitBtn = document.getElementById("submitBtn");

const selected = new Array(CIRCLES.length).fill(false);

function el(name, attrs = {}) {
  const n = document.createElementNS("http://www.w3.org/2000/svg", name);
  for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, v);
  return n;
}

function svgPointFromEvent(ev){
  const pt = svg.createSVGPoint();
  pt.x = ev.clientX; pt.y = ev.clientY;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}

function nearestCircleIndex(x, y){
  let bestIdx = -1;
  let bestD2 = Infinity;
  for (let i=0;i<CIRCLES.length;i++){
    const dx = x - CIRCLES[i].x;
    const dy = y - CIRCLES[i].y;
    const d2 = dx*dx + dy*dy;
    if (d2 < bestD2){
      bestD2 = d2;
      bestIdx = i;
    }
  }
  if (bestIdx === -1) return -1;
  return bestD2 <= SNAP_DIST*SNAP_DIST ? bestIdx : -1;
}

function render(){
  // 清掉旧的 hit/dot（保留 image 和 catcher）
  [...svg.querySelectorAll(".hit,.dot")].forEach(n => n.remove());

  CIRCLES.forEach((c, i) => {
    // 点击命中圈（半径可比红点略大，方便点到）
    const hit = el("circle", { cx: c.x, cy: c.y, r: Math.max(R_DOT+2, 18) });
    hit.classList.add("hit");
    if (selected[i]) hit.classList.add("selected");

    const dot = el("circle", { cx: c.x, cy: c.y, r: R_DOT });
    dot.classList.add("dot");

    // 注意：真正点击事件统一挂在 catcher 上（吸附），这里不挂 click
    svg.appendChild(hit);
    svg.appendChild(dot);
  });

  const chosen = selected.map((v,i)=>v?(i+1):null).filter(v=>v!==null);
  msg.textContent = `已选择 ${chosen.length} 个圆点。`;
}

function sameSet(a, b){
  if (a.length !== b.length) return false;
  for (let i=0;i<a.length;i++) if (a[i] !== b[i]) return false;
  return true;
}

bg.addEventListener("load", () => {
  render();
});

bg.addEventListener("error", () => {
  msg.textContent = "图片加载失败：请确认根目录存在 map.png（严格小写）且能通过 /map.png 打开。";
  msg.style.background = "#fdecec";
});

// 点击整张图 -> 找最近圆 -> 切换选中
catcher.addEventListener("click", (ev) => {
  const p = svgPointFromEvent(ev);
  const idx = nearestCircleIndex(p.x, p.y);
  if (idx === -1) return; // 点得太远就不响应
  selected[idx] = !selected[idx];
  render();
}, { passive:false });

submitBtn.addEventListener("click", () => {
  const chosen = selected.map((v,i)=>v?(i+1):null).filter(v=>v!==null).sort((a,b)=>a-b);
  const ans = [...ANSWER_NUMS].sort((a,b)=>a-b);

  if (sameSet(chosen, ans)){
    msg.textContent = "Success";
    msg.style.background = "#e9f7ef";
  } else {
    msg.textContent = "Please try again";
    msg.style.background = "#fdecec";
  }
});
</script>
</body>
</html>
