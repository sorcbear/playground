<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circle Puzzle Debugger</title>
  <style>
    body { margin: 0; background: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
    .container { position: relative; margin-top: 20px; background: #fff; line-height: 0; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
    
    /* 核心：SVG 必须完全覆盖在图片上方 */
    #puzzleSvg {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 10;
    }
    img { width: 918px; height: 1024px; display: block; }

    .visual-dot { fill: rgba(220, 0, 0, 0.8); pointer-events: none; }
    .hit-area { fill: transparent; cursor: pointer; pointer-events: all; }
    
    /* 调试面板 */
    .debug-panel {
      width: 918px; background: #333; color: #fff; padding: 20px; 
      margin-top: 10px; box-sizing: border-box; border-radius: 8px;
    }
    #coordsOutput { width: 100%; height: 100px; background: #000; color: #0f0; font-family: monospace; margin-top: 10px; }
  </style>
</head>
<body>

  <div class="container">
    <img src="map.jpg" id="baseImg" alt="map">
    <svg viewBox="0 0 918 1024" id="puzzleSvg"></svg>
  </div>

  <div class="debug-panel">
    <strong>调试模式：</strong> 点击图片上的圆圈，下方会自动生成修正后的坐标。
    <br>点击后将生成的代码替换到脚本中的 <code>CIRCLES</code> 数组即可。
    <textarea id="coordsOutput" readonly placeholder='点击圆圈获取坐标...'></textarea>
    <button onclick="clearOutput()" style="margin-top:10px; padding:10px;">清空输出</button>
  </div>

<script>
// --- 这里是之前可能有误的坐标 ---
let CIRCLES = [
  {"x":677,"y":83},{"x":751,"y":88},{"x":376,"y":166},{"x":476,"y":168} // ... 仅作示例
];

const svg = document.getElementById("puzzleSvg");
const output = document.getElementById("coordsOutput");
const collected = [];

// 1. 初始化现有的圆圈看偏差
function init() {
  CIRCLES.forEach((c, i) => drawPoint(c.x, c.y));
}

function drawPoint(x, y) {
  const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
  const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  dot.setAttribute("cx", x); dot.setAttribute("cy", y);
  dot.setAttribute("r", "16");
  dot.setAttribute("class", "visual-dot");
  g.appendChild(dot);
  svg.appendChild(g);
}

// 2. 核心：点击获取精准坐标
svg.addEventListener("click", (e) => {
  const pt = svg.createSVGPoint();
  pt.x = e.clientX;
  pt.y = e.clientY;
  
  // 关键：将屏幕点击坐标转换为 SVG 内部坐标（即图片像素坐标）
  const svgPt = pt.matrixTransform(svg.getScreenCTM().inverse());
  
  const nx = Math.round(svgPt.x);
  const ny = Math.round(svgPt.y);
  
  // 记录并显示
  collected.push({x: nx, y: ny});
  drawPoint(nx, ny);
  updateOutput();
});

function updateOutput() {
  output.value = JSON.stringify(collected);
}

function clearOutput() {
  collected.length = 0;
  output.value = "";
  // 清除除了图片外的所有圆圈
  while (svg.firstChild) svg.removeChild(svg.firstChild);
}

init();
</script>
</body>
</html>
