<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    html, body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:#ffffff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }

    .container{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
      padding:18px;
      box-sizing:border-box;
      text-align:center;
    }

    .hint{
      min-height:48px;
      font-size:16px;
      line-height:1.7;
      color:#111;
      white-space:pre-wrap;
      user-select:none;
    }

    .status{
      min-height:26px;
      font-size:18px;
      font-weight:700;
      letter-spacing:.5px;
      color:#111;
      user-select:none;
    }

    .panel{
      width:min(520px, 92vw);
      display:none;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }

    .panel input{
      width:100%;
      height:46px;
      padding:0 14px;
      box-sizing:border-box;
      font-size:16px;
      border:2px solid #000;
      border-radius:10px;
      outline:none;
      text-transform:uppercase;
      letter-spacing:1px;
    }

    .panel .row{
      width:100%;
      display:flex;
      gap:10px;
    }

    button{
      padding:16px 36px;
      font-size:18px;
      font-weight:600;
      letter-spacing:1px;
      background:#ffffff;
      color:#000000;
      border:2px solid #000000;
      cursor:pointer;
    }

    button:hover{ background:#000000; color:#ffffff; }
    button:disabled{ opacity:.45; cursor:default; }

    .small{
      font-size:13px;
      color:#444;
      line-height:1.5;
      user-select:none;
    }
  </style>
</head>

<body>
<div class="container">
  <div class="hint" id="hint"></div>
  <div class="status" id="status"></div>

  <div class="panel" id="panel">
    <div class="small">请输入游戏码</div>
    <input id="codeInput" placeholder="XXXX-XXXX" autocomplete="off" />
    <div class="row">
      <button id="verifyBtn" style="flex:1;">验证</button>
      <button id="cancelBtn" style="flex:1;">取消</button>
    </div>
    <div class="small" id="err" style="color:#b00020; min-height:18px;"></div>
  </div>

  <button id="mainBtn">确定</button>
</div>

<script>
(() => {
  const VERIFY_ENDPOINT = "https://1396901144-84o46m5fmk.ap-shanghai.tencentscf.com/verify";
  const NEXT_URL = "./rotate/";
  const PASS_KEY = "playground_pass_v1";

  const NOTE_GAP_SEC = 0.25;
  const NOTE_DUR_SEC = 0.22;
  const COUNTDOWN_SEC = 10;

  const CORRECT_MIDI_SEQ = [60,64,67,72,76,67,72,76];

  let audioCtx = null;
  let audioEnabled = false;

  function ensureAudioCtx(){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!audioCtx) audioCtx = new AC();
    return audioCtx;
  }

  async function enableAudio(){
    const ctx = ensureAudioCtx();
    if(ctx.state === "suspended") await ctx.resume();
    audioEnabled = true;
  }

  function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }

  function playTone(freq, duration){
    if(!audioEnabled || !audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.001, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0.25, audioCtx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + duration);
  }

  function playMelody(){
    CORRECT_MIDI_SEQ.forEach((m,i)=>{
      setTimeout(()=>playTone(midiToFreq(m), NOTE_DUR_SEC), i*NOTE_GAP_SEC*1000);
    });
  }

  function setPass(){
    localStorage.setItem(PASS_KEY, "pass_"+Date.now());
  }

  function normalizeCode(s){
    return String(s||"").trim().toUpperCase().replace(/\s+/g,"");
  }

  async function verifyCode(code){
    const r = await fetch(VERIFY_ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({code})
    });
    const data = await r.json().catch(()=>({}));
    return data;
  }

  const hintEl = document.getElementById("hint");
  const statusEl = document.getElementById("status");
  const panel = document.getElementById("panel");
  const mainBtn = document.getElementById("mainBtn");
  const verifyBtn = document.getElementById("verifyBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const codeInput = document.getElementById("codeInput");
  const errEl = document.getElementById("err");

  // 0 确认页
  // 1 验证页
  // 2 验证成功过渡
  // 3 开始游戏页
  // 4 音乐倒计时
  let phase = 0;
  let timers = [];

  function clearTimers(){ timers.forEach(t=>clearTimeout(t)); timers=[]; }
  function delay(fn,ms){ const t=setTimeout(fn,ms); timers.push(t); }

  function render(){
    if(phase===0){
      hintEl.textContent = "确定要玩这个游戏吗？\n这可能影响你和其他人的命运......";
      panel.style.display="none";
      mainBtn.disabled=false;
      mainBtn.textContent="确定";
      statusEl.textContent="";
    }
    if(phase===1){
      hintEl.textContent="";
      panel.style.display="flex";
      mainBtn.disabled=true;
      statusEl.textContent="";
    }
    if(phase===2){
      panel.style.display="none";
      mainBtn.disabled=true;
      hintEl.textContent="";
      statusEl.textContent="验证成功";
    }
    if(phase===3){
      panel.style.display="none";
      mainBtn.disabled=false;
      mainBtn.textContent="开始游戏";
      hintEl.textContent="";
      statusEl.textContent="";
    }
    if(phase===4){
      panel.style.display="none";
      mainBtn.disabled=true;
      hintEl.textContent="好像听到一段诡异的音乐......";
    }
  }

  function startCountdown(){
    let left = COUNTDOWN_SEC;
    const tick=()=>{
      statusEl.textContent=`倒计时：${left}`;
      if(left<=0){ location.href=NEXT_URL; return; }
      left--; delay(tick,1000);
    };
    tick();
  }

  async function startGame(){
    phase=4;
    render();
    await enableAudio();
    playMelody();
    startCountdown();
  }

  mainBtn.onclick=()=>{
    if(phase===0){ phase=1; render(); codeInput.focus(); }
    else if(phase===3){ startGame(); }
  };

  cancelBtn.onclick=()=>{
    phase=0; render();
  };

  verifyBtn.onclick=async()=>{
    const code = normalizeCode(codeInput.value);
    if(!code){ errEl.textContent="请输入游戏码"; return; }
    statusEl.textContent="验证中...";
    const r = await verifyCode(code);
    if(r.ok && r.reason==="verified"){
      setPass();
      phase=2;
      render();
      delay(()=>{ phase=3; render(); },1000);
    }else{
      errEl.textContent="验证失败";
      statusEl.textContent="";
    }
  };

  render();
})();
</script>
</body>
</html>
