<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* ===== 尺度标准（只改这里即可全站统一）===== */
      --maxw: 720px;
      --panelw: 420px;

      --fs-body: 16px;     /* 正文 */
      --lh-body: 1.7;

      --fs-hint: 18px;     /* 提示/标题 */
      --lh-hint: 1.6;

      --fs-status: 18px;   /* 状态 */
      --fw-status: 700;

      --fs-btn: 16px;      /* 按钮文字 */
      --fw-btn: 600;
      --h-btn: 52px;       /* 按钮高度 */

      --fs-input: 16px;    /* 输入框文字 */
      --h-input: 52px;     /* 输入框高度 */

      --gap: 18px;
      --gap-tight: 12px;

      --c-text: #111;
      --c-muted: #444;
      --c-danger: #b00020;
      --c-border: #000;
    }

    html, body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      font-size: var(--fs-body);
      line-height: var(--lh-body);
      color: var(--c-text);
    }

    .container{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: var(--gap);
      padding:18px;
      box-sizing:border-box;
      text-align:center;
    }

    /* 主叙事/提示 */
    .hint{
      width: min(var(--maxw), 92vw);
      min-height: 56px;
      font-size: var(--fs-hint);
      line-height: var(--lh-hint);
      color: var(--c-text);
      white-space: pre-wrap;
      user-select:none;
      margin: 0;
    }

    /* 状态 */
    .status{
      width: min(var(--maxw), 92vw);
      min-height: 28px;
      font-size: var(--fs-status);
      font-weight: var(--fw-status);
      letter-spacing: 0; /* 标准化：去掉字距避免中英文不一致 */
      color: var(--c-text);
      user-select:none;
      margin: 0;
    }

    /* 输入面板 */
    .panel{
      width: min(var(--panelw), 92vw);
      display:none;
      flex-direction:column;
      gap: var(--gap-tight);
      align-items:stretch;
    }

    .panel .label{
      font-size: var(--fs-hint);   /* “请输入游戏码”归入提示层级 */
      line-height: var(--lh-hint);
      color: var(--c-text);
      user-select:none;
      margin-bottom: 2px;
    }

    .panel input{
      width:100%;
      height: var(--h-input);
      padding:0 14px;
      box-sizing:border-box;
      font-size: var(--fs-input);
      border:2px solid var(--c-border);
      border-radius:12px;
      outline:none;
      text-transform:uppercase;
      letter-spacing: 0; /* 标准化：输入也不拉字距 */
    }

    .row{
      display:flex;
      gap:12px;
      width:100%;
    }

    button{
      height: var(--h-btn);
      padding: 0 18px;
      box-sizing: border-box;
      font-size: var(--fs-btn);
      font-weight: var(--fw-btn);
      letter-spacing: 0; /* 标准化：按钮不拉字距 */
      background:#fff;
      color:#000;
      border:2px solid var(--c-border);
      cursor:pointer;
      border-radius: 0; /* 保持你原本“硬朗”风格，可按需改成 10px */
    }

    button:hover{ background:#000; color:#fff; }
    button:disabled{ opacity:.45; cursor:default; }

    /* 错误提示 */
    .err{
      min-height: 20px;
      font-size: 14px; /* 错误信息可比正文略小，但固定 */
      line-height: 1.5;
      color: var(--c-danger);
      user-select:none;
    }

    /* 主按钮容器：用于在某些阶段彻底隐藏 */
    .mainWrap{
      display:flex;
      justify-content:center;
      width: min(var(--maxw), 92vw);
    }

    /* 手机上稍微紧凑一点 */
    @media (max-width: 420px){
      :root{
        --fs-hint: 17px;
        --fs-status: 17px;
        --h-btn: 50px;
        --h-input: 50px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="hint" id="hint"></div>
    <div class="status" id="status"></div>

    <!-- 核销输入区 -->
    <div class="panel" id="panel">
      <div class="label">请输入游戏码</div>
      <input id="codeInput" placeholder="XXXX-XXXX" autocomplete="off" inputmode="latin" />
      <div class="row">
        <button id="verifyBtn" style="flex:1;">验证</button>
        <button id="cancelBtn" style="flex:1;">取消</button>
      </div>
      <div class="err" id="err"></div>
    </div>

    <!-- 主按钮：用容器包起来，方便某些阶段直接不显示 -->
    <div class="mainWrap" id="mainWrap">
      <button id="mainBtn" style="min-width: 220px;">确定</button>
    </div>
  </div>

<script>
(() => {
  const VERIFY_ENDPOINT = "https://1396901144-84o46m5fmk.ap-shanghai.tencentscf.com/verify";
  const NEXT_URL = "./rotate/";
  const PASS_KEY = "playground_pass_v1";

  const NOTE_GAP_SEC = 0.25;
  const NOTE_DUR_SEC = 0.22;
  const COUNTDOWN_SEC = 10;

  // ===== 原版音乐 =====
  const KEYS = [
    {c:"green",n:"so",m:55},
    {c:"green",n:"la",m:57},
    {c:"green",n:"si",m:59},
    {c:"red",n:"do",m:60},
    {c:"red",n:"re",m:62},
    {c:"red",n:"mi",m:64},
    {c:"red",n:"fa",m:65},
    {c:"red",n:"so",m:67},
    {c:"red",n:"la",m:69},
    {c:"red",n:"si",m:71},
    {c:"blue",n:"do",m:72},
    {c:"blue",n:"re",m:74},
    {c:"blue",n:"mi",m:76},
    {c:"blue",n:"fa",m:77},
    {c:"blue",n:"so",m:79},
    {c:"blue",n:"la",m:81},
  ];

  const target = [
    ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
    ["red","do"],["red","re"],["red","la"],["blue","re"],["blue","fa"],["red","la"],["blue","re"],["blue","fa"],
    ["green","si"],["red","re"],["red","so"],["blue","re"],["blue","fa"],["red","so"],["blue","re"],["blue","fa"],
    ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
  ];

  function targetToMidiSeq(){
    const seq = [];
    for(const [tc, tn] of target){
      const idx = KEYS.findIndex(k => k.c===tc && k.n===tn);
      if(idx >= 0) seq.push(KEYS[idx].m);
    }
    return seq;
  }
  const CORRECT_MIDI_SEQ = targetToMidiSeq();

  let audioCtx = null;
  let audioEnabled = false;

  function ensureAudioCtx(){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!audioCtx) audioCtx = new AC();
    return audioCtx;
  }

  async function enableAudio(){
    const ctx = ensureAudioCtx();
    if(ctx.state === "suspended") await ctx.resume();
    audioEnabled = true;
  }

  function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }

  function playTone(freq, duration=1.25){
    if(!audioEnabled || !audioCtx) return;
    const now = audioCtx.currentTime;

    const o1 = audioCtx.createOscillator();
    const o2 = audioCtx.createOscillator();
    const o3 = audioCtx.createOscillator();
    o1.type = "sine";
    o2.type = "triangle";
    o3.type = "square";

    o1.frequency.setValueAtTime(freq, now);
    o2.frequency.setValueAtTime(freq * 2, now);
    o3.frequency.setValueAtTime(freq * 4, now);

    const g1 = audioCtx.createGain(); g1.gain.value = 1.0;
    const g2 = audioCtx.createGain(); g2.gain.value = 0.55;
    const g3 = audioCtx.createGain(); g3.gain.value = 0.06;

    const amp = audioCtx.createGain();
    amp.gain.setValueAtTime(0.0001, now);
    amp.gain.linearRampToValueAtTime(0.33, now + 0.015);
    amp.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.setValueAtTime(Math.min(freq * 6, 9000), now);
    lp.Q.value = 0.85;

    o1.connect(g1); g1.connect(amp);
    o2.connect(g2); g2.connect(amp);
    o3.connect(g3); g3.connect(amp);
    amp.connect(lp); lp.connect(audioCtx.destination);

    o1.start(now); o2.start(now); o3.start(now);
    const stopAt = now + duration + 0.10;
    o1.stop(stopAt); o2.stop(stopAt); o3.stop(stopAt);
  }

  function playCorrectMelodyFixedGap(){
    CORRECT_MIDI_SEQ.forEach((midi, i) => {
      setTimeout(() => {
        playTone(midiToFreq(midi), NOTE_DUR_SEC);
      }, Math.round(i * NOTE_GAP_SEC * 1000));
    });
  }

  function setPass(){
    const token = "pass_" + Math.random().toString(36).slice(2) + "_" + Date.now();
    localStorage.setItem(PASS_KEY, token);
  }
  function hasPass(){
    return !!localStorage.getItem(PASS_KEY);
  }

  // reset=1 强制回到输入码
  const params = new URLSearchParams(location.search);
  if (params.get("reset") === "1") {
    localStorage.removeItem(PASS_KEY);
  }

  function normalizeCode(s){
    return String(s || "")
      .trim()
      .toUpperCase()
      .replace(/\s+/g, "")
      .replace(/—/g, "-")
      .replace(/–/g, "-");
  }

  async function verifyCode(code){
    const r = await fetch(VERIFY_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code }),
    });
    const data = await r.json().catch(() => ({}));
    return { httpOk: r.ok, data };
  }

  const mainBtn = document.getElementById("mainBtn");
  const mainWrap = document.getElementById("mainWrap");
  const hintEl = document.getElementById("hint");
  const statusEl = document.getElementById("status");

  const panel = document.getElementById("panel");
  const codeInput = document.getElementById("codeInput");
  const verifyBtn = document.getElementById("verifyBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const errEl = document.getElementById("err");

  // 0: 确认页
  // 1: 输入码页
  // 2: 验证成功过渡(1s)
  // 3: 开始游戏页
  // 4: 音乐+倒计时
  let phase = 0;
  let timers = [];

  function clearTimers(){
    timers.forEach(id => clearTimeout(id));
    timers = [];
  }
  function schedule(fn, ms){
    const id = setTimeout(fn, ms);
    timers.push(id);
    return id;
  }

  function showPanel(show){
    panel.style.display = show ? "flex" : "none";
  }

  function setError(msg){
    errEl.textContent = msg || "";
  }

  function showMain(show){
    mainWrap.style.display = show ? "flex" : "none";
  }

  function render(){
    if(phase === 0){
      showPanel(false);
      showMain(true);
      mainBtn.disabled = false;
      mainBtn.textContent = "确定";
      hintEl.textContent = "确定要玩这个游戏吗？\n这可能影响你和其他人的命运......";
      statusEl.textContent = "";
      setError("");
      return;
    }

    if(phase === 1){
      showPanel(true);
      showMain(false);          // ✅ 验证界面不显示“确定/开始游戏”按钮
      hintEl.textContent = "";
      statusEl.textContent = "";
      setError("");
      return;
    }

    if(phase === 2){
      showPanel(false);
      showMain(false);          // 过渡阶段也不显示主按钮
      hintEl.textContent = "";
      statusEl.textContent = "验证成功";
      setError("");
      return;
    }

    if(phase === 3){
      showPanel(false);
      showMain(true);
      mainBtn.disabled = false;
      mainBtn.textContent = "开始游戏";
      hintEl.textContent = "";
      statusEl.textContent = "";
      setError("");
      return;
    }

    if(phase === 4){
      showPanel(false);
      showMain(true);
      mainBtn.disabled = true;
      mainBtn.textContent = "开始游戏";
      hintEl.textContent = "好像听到一段诡异的音乐......";
      return;
    }
  }

  function startCountdown10s(){
    let left = COUNTDOWN_SEC;
    const tick = () => {
      statusEl.textContent = `倒计时：${left}`;
      if(left <= 0){
        location.href = NEXT_URL;
        return;
      }
      left--;
      schedule(tick, 1000);
    };
    tick();
  }

  async function startMusicAndCountdown(){
    phase = 4;
    clearTimers();
    render();
    try{ await enableAudio(); }catch(e){}
    playCorrectMelodyFixedGap();
    startCountdown10s();
  }

  async function doVerify(){
    const code = normalizeCode(codeInput.value);
    if(!code){
      setError("请输入游戏码");
      return;
    }

    verifyBtn.disabled = true;
    cancelBtn.disabled = true;
    setError("");
    statusEl.textContent = "验证中...";

    try{
      const { httpOk, data } = await verifyCode(code);
      const ok = !!data.ok;
      const reason = String(data.reason || "");

      if(ok && reason === "verified"){
        setPass();
        phase = 2;
        clearTimers();
        render();
        schedule(() => { phase = 3; render(); }, 1000);
        return;
      }

      if(!ok && reason === "already_used"){
        statusEl.textContent = "";
        setError("该游戏码已被使用");
        return;
      }

      if(!ok && reason === "not_found"){
        statusEl.textContent = "";
        setError("游戏码不存在");
        return;
      }

      statusEl.textContent = "";
      const msg = data.message ? String(data.message) : (httpOk ? "验证失败" : "网络错误");
      setError(msg);
    }catch(e){
      statusEl.textContent = "";
      setError("网络错误，请重试");
    }finally{
      verifyBtn.disabled = false;
      cancelBtn.disabled = false;
      codeInput.focus();
      codeInput.select();
    }
  }

  mainBtn.addEventListener("click", async () => {
    if(phase === 0){
      phase = 1;
      clearTimers();
      render();
      codeInput.value = "";
      codeInput.focus();
      return;
    }
    if(phase === 3){
      await startMusicAndCountdown();
      return;
    }
  });

  cancelBtn.addEventListener("click", () => {
    phase = 0;
    clearTimers();
    render();
  });

  verifyBtn.addEventListener("click", doVerify);
  codeInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") doVerify();
  });

  // 初始化：已验证设备直接进“开始游戏”页
  phase = hasPass() ? 3 : 0;
  render();
})();
</script>
</body>
</html>
