<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Save</title>

  <style>
    :root{
      --fs-body: 18px;

      --btn-h: 56px;
      --btn-w: 140px;

      --bg:#fff;
      --c-border:#000;

      --map-w: 780;
      --map-h: 520;

      /* 线条粗细（像素） */
      --line-w: 8px;

      /* 顶部方块尺寸 */
      --cap-sz: 34px;
    }

    *{ box-sizing:border-box; }

    html,body{
      margin:0;
      padding:0;
      background:#fff;
      font-family: system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial, sans-serif;
      font-size:var(--fs-body);
      color:#111;
    }

    .wrap{
      min-height:100svh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    /* 顶部提示 */
    .notice{
      width:100%;
      text-align:center;
      font-size:13px;
      font-weight:700;
      color:#000;
      margin: 4px 0 14px;
    }

    .map{
      position:relative;
      width:min(780px, 100%);
      aspect-ratio: calc(var(--map-w) / var(--map-h));
    }

    .wires{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* 节点用百分比定位，与 svg 同坐标系 */
    .node{
      position:absolute;
      transform:translate(-50%,-50%);
    }

    /* 顶部“方块节点”（非按钮） */
    .cap{
      width: var(--cap-sz);
      height: var(--cap-sz);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cap svg{ width:100%; height:100%; display:block; }

    /* 按钮 */
    .btn{
      width:var(--btn-w);
      height:var(--btn-h);

      display:flex;
      align-items:center;
      justify-content:center;   /* 图标+文字整体居中 */
      gap:8px;

      font-size:var(--fs-body);
      font-weight:600;

      background:#fff;
      color:#000;
      border:2px solid var(--c-border);
      cursor:pointer;
      border-radius:0;

      appearance:none;
      -webkit-appearance:none;
      background-image:none;
      box-shadow:none;

      white-space:nowrap;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }

    .btn:hover{
      background:#000;
      color:#fff;
    }

    .ico{
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }

    .ico svg{
      width:100%;
      height:100%;
      display:block;
    }

    /* 起点三角：白底白三角，hover 黑底黑三角 */
    .start-tri{ fill:#fff; }
    .btn:hover .start-tri{ fill:#000; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="notice">为保留进度，请勿使用浏览器无痕模式。</div>

    <div class="map" id="map">
      <!-- 统一 0~100 坐标系 -->
      <svg class="wires" id="wires"
           viewBox="0 0 100 100"
           preserveAspectRatio="none"
           aria-hidden="true"></svg>
    </div>
  </div>

  <script>
    // ===== 存档 key =====
    const K_UNLOCK_CIRCLE = "pg_unlock_circle_v1";
    const K_UNLOCK_SQUARE = "pg_unlock_square_v1";
    const K_UNLOCK_PPL    = "pg_unlock_ppl_v1";

    function safeGet(storage, key){
      try{ return storage.getItem(key); }catch(e){ return null; }
    }
    function unlocked(key){
      if (!key) return true;
      return !!(safeGet(localStorage, key) || safeGet(sessionStorage, key));
    }

    // ===== 坐标（百分比 0~100）=====
    // 顶部方块（始终显示）
    const CAP = { x: 28.205, y: 8.000 };  // 你可以微调 y（越小越靠上）

    // 节点按钮（按解锁逐个显示）
    const NODES = [
      { text:"起点",   url:"https://sorcbear.github.io/playground/rotate", need:null,            x:28.205, y:23.077, icon:svgStart },
      { text:"天平路", url:"https://sorcbear.github.io/playground/circle", need:K_UNLOCK_CIRCLE, x:28.205, y:50.000, icon:svgBlue  },
      { text:"康平路", url:"https://sorcbear.github.io/playground/square", need:K_UNLOCK_SQUARE, x:66.667, y:50.000, icon:svgGreen },
      { text:"衡山路", url:"https://sorcbear.github.io/playground/ppl",    need:K_UNLOCK_PPL,    x:66.667, y:76.923, icon:svgRed   }
    ];

    function visibleNodes(){
      const out=[];
      for (const n of NODES){
        if (!unlocked(n.need)) break;
        out.push(n);
      }
      return out;
    }

    function makeBtn(n){
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.type = "button";
      btn.innerHTML = `<span class="ico">${n.icon()}</span><span>${n.text}</span>`;
      btn.onclick = () => location.href = n.url;
      return btn;
    }

    function makeCap(){
      const d = document.createElement("div");
      d.className = "cap";
      d.innerHTML = svgCap();
      return d;
    }

    function render(){
      const map = document.getElementById("map");
      const wires = document.getElementById("wires");

      map.querySelectorAll(".node").forEach(el=>el.remove());
      wires.innerHTML = "";

      // 线条参数（像素宽，且不随缩放变粗细）
      const lw = parseFloat(getComputedStyle(document.documentElement)
        .getPropertyValue("--line-w")) || 8;

      function addLine(x1,y1,x2,y2){
        const ln = document.createElementNS("http://www.w3.org/2000/svg","line");
        ln.setAttribute("x1",x1);
        ln.setAttribute("y1",y1);
        ln.setAttribute("x2",x2);
        ln.setAttribute("y2",y2);
        ln.setAttribute("stroke","#000");
        ln.setAttribute("stroke-width",lw);
        ln.setAttribute("vector-effect","non-scaling-stroke");
        ln.setAttribute("stroke-linecap","square");
        wires.appendChild(ln);
      }

      // ✅ 先放顶部方块节点（始终显示）
      const capNode = document.createElement("div");
      capNode.className = "node";
      capNode.style.left = CAP.x + "%";
      capNode.style.top  = CAP.y + "%";
      capNode.appendChild(makeCap());
      map.appendChild(capNode);

      // ✅ 再放按钮节点（按解锁逐个显示）
      const vis = visibleNodes();
      for (const n of vis){
        const wrap = document.createElement("div");
        wrap.className = "node";
        wrap.style.left = n.x + "%";
        wrap.style.top  = n.y + "%";
        wrap.appendChild(makeBtn(n));
        map.appendChild(wrap);
      }

      // ✅ 画线：方块 -> 起点（始终显示）
      // 起点一定在 vis[0]，因为起点 need=null
      addLine(CAP.x, CAP.y, NODES[0].x, NODES[0].y);

      // 后续线段按解锁逐段显示
      if (vis.length>=2) addLine(NODES[0].x,NODES[0].y,NODES[1].x,NODES[1].y);
      if (vis.length>=3) addLine(NODES[1].x,NODES[1].y,NODES[2].x,NODES[2].y);
      if (vis.length>=4) addLine(NODES[2].x,NODES[2].y,NODES[3].x,NODES[3].y);
    }

    // ===== 图标 =====
    function svgCap(){
      return `<svg viewBox="0 0 64 64" aria-hidden="true"><rect x="8" y="8" width="48" height="48" fill="#000"/></svg>`;
    }
    function svgStart(){
      return `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <circle cx="32" cy="32" r="26" fill="#F6B300"/>
          <path class="start-tri" d="M32 32L58 18v28L32 32Z"/>
        </svg>`;
    }
    function svgBlue(){
      return `<svg viewBox="0 0 64 64" aria-hidden="true"><rect x="12" y="12" width="40" height="40" fill="#1E73D8"/></svg>`;
    }
    function svgGreen(){
      return `<svg viewBox="0 0 64 64" aria-hidden="true"><circle cx="32" cy="32" r="20" fill="#2E7D32"/></svg>`;
    }
    function svgRed(){
      return `<svg viewBox="0 0 64 64" aria-hidden="true"><path d="M32 10L54 32 32 54 10 32Z" fill="#D32F2F"/></svg>`;
    }

    render();
  </script>
</body>
</html>
