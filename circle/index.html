<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circle Puzzle</title>
  <style>
    :root { 
      --maxw: 720px;
      --text: #111;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      background:#fff;
      color:var(--text);
    }
    .wrap{ max-width:var(--maxw); margin:0 auto; padding:12px; }

    /* 标题 */
    .title{
      font-size:20px;
      font-weight:500;
      color:var(--text);
      text-align:left;
      margin-bottom:0.6em;
    }
    .subtitle{
      font-size:13px;
      line-height:1.6;
      color:#444;
      margin-bottom:2.2em;
    }

    .stage{
      width:100%;
      aspect-ratio:918/1024;
      border-radius:10px;
      overflow:hidden;
      background:#fff;
      touch-action:manipulation;
      user-select:none;
    }
    svg{ width:100%; height:100%; display:block; }

    /* 圆点显示 */
    .hit{ fill:transparent; pointer-events:none; }
    .dot{ fill:transparent; pointer-events:none; }
    .hit.selected + .dot{ fill:rgba(220,0,0,0.92); }

    .hint{
      margin-top:12px;
      padding:0;
      background:transparent;
      font-size:14px;
      line-height:1.5;
    }

    .panel{
      display:flex;
      gap:12px;
      margin-top:12px;
    }

    button{
      appearance:none;
      border:0;
      background:#111;
      color:#fff;
      padding:14px 16px;
      border-radius:14px;
      font-size:16px;
      font-weight:700;
      width:50%;
    }
    button:active{ transform:translateY(1px); }
    button:disabled{ opacity:0.5; }

    .msg{
      margin-top:12px;
      padding:0;
      background:transparent;
      font-size:14px;
      min-height:1.4em;
    }
  </style>
</head>
<body>
<div class="wrap">

  <!-- 标题区 -->
  <div class="title">一些实用的地方</div>
  <div class="subtitle">
    请走到老吉士马路对面，然后往左边方向前进，留意100米范围内的墙面信息，找到线索解题。
  </div>

  <div class="stage">
    <svg viewBox="0 0 918 1024" preserveAspectRatio="xMidYMid meet" id="svg"
         xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink">
      <image id="bg"
             href="map.png" xlink:href="map.png"
             x="0" y="0" width="918" height="1024"
             preserveAspectRatio="xMidYMid meet"
             style="pointer-events:none;"></image>

      <rect id="catcher"
            x="0" y="0" width="918" height="1024"
            fill="transparent"
            style="pointer-events:all;"></rect>
    </svg>
  </div>

  <div class="hint">
    请结合环境信息，在上图中点击正确位置的圆圈后提交。
  </div>

  <div class="panel">
    <button id="undoBtn">Undo</button>
    <button id="submitBtn">Submit</button>
  </div>

  <div class="msg" id="msg"></div>

</div>

<script>
const CIRCLES = [{"x":678,"y":84},{"x":752,"y":88},{"x":376,"y":166},{"x":473,"y":196},{"x":553,"y":171},{"x":657,"y":219},{"x":307,"y":263},{"x":886,"y":187},{"x":444,"y":247},{"x":115,"y":274},{"x":256,"y":209},{"x":806,"y":211},{"x":879,"y":318},{"x":217,"y":346},{"x":303,"y":346},{"x":547,"y":349},{"x":267,"y":638},{"x":105,"y":346},{"x":78,"y":434},{"x":56,"y":541},{"x":189,"y":548},{"x":164,"y":460},{"x":585,"y":491},{"x":438,"y":491},{"x":369,"y":579},{"x":813,"y":847},{"x":274,"y":550},{"x":485,"y":431},{"x":617,"y":305},{"x":608,"y":617},{"x":535,"y":573},{"x":839,"y":590},{"x":825,"y":659},{"x":897,"y":421},{"x":390,"y":673},{"x":303,"y":718},{"x":527,"y":663},{"x":486,"y":728},{"x":862,"y":744},{"x":730,"y":172},{"x":644,"y":827},{"x":506,"y":865},{"x":433,"y":878},{"x":332,"y":893},{"x":206,"y":774},{"x":186,"y":622}];

const ANSWER_POINTS = [
  {x:376,y:166},{x:217,y:346},{x:303,y:346},
  {x:78,y:434},{x:274,y:550},{x:825,y:659},
  {x:303,y:718},{x:644,y:827},{x:433,y:878}
];

const NEXT_URL = "https://sorcbear.github.io/playground/track/";
const REDIRECT_DELAY = 600;

const R_DOT=10, SNAP_DIST=36, EPS=10;

const svg=document.getElementById("svg");
const catcher=document.getElementById("catcher");
const msg=document.getElementById("msg");
const submitBtn=document.getElementById("submitBtn");
const undoBtn=document.getElementById("undoBtn");

const selected=new Array(CIRCLES.length).fill(false);

function el(n,a={}){const e=document.createElementNS("http://www.w3.org/2000/svg",n);for(const k in a)e.setAttribute(k,a[k]);return e;}
function svgPt(ev){const p=svg.createSVGPoint();p.x=ev.clientX;p.y=ev.clientY;return p.matrixTransform(svg.getScreenCTM().inverse());}
function d2(a,b){const dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy;}
function nearest(x,y){
  let bi=-1,bd=1e9;
  CIRCLES.forEach((c,i)=>{const dx=x-c.x,dy=y-c.y,dd=dx*dx+dy*dy;if(dd<bd){bd=dd;bi=i;}});
  return bd<=SNAP_DIST*SNAP_DIST?bi:-1;
}
function sameSet(u,a){
  if(u.length!==a.length)return false;
  const used=new Array(u.length).fill(false);
  for(const p of a){
    let ok=false;
    for(let i=0;i<u.length;i++){
      if(!used[i]&&d2(p,u[i])<=EPS*EPS){used[i]=true;ok=true;break;}
    }
    if(!ok)return false;
  }
  return true;
}
function userPts(){return selected.map((v,i)=>v?CIRCLES[i]:null).filter(Boolean);}
function render(){
  svg.querySelectorAll(".hit,.dot").forEach(n=>n.remove());
  CIRCLES.forEach((c,i)=>{
    const h=el("circle",{cx:c.x,cy:c.y,r:20});
    h.classList.add("hit");
    if(selected[i])h.classList.add("selected");
    const d=el("circle",{cx:c.x,cy:c.y,r:R_DOT});
    d.classList.add("dot");
    svg.insertBefore(h,catcher);
    svg.insertBefore(d,catcher);
  });
}

catcher.addEventListener("pointerdown",e=>{
  e.preventDefault();
  const p=svgPt(e);
  const i=nearest(p.x,p.y);
  if(i<0)return;
  selected[i]=!selected[i];
  msg.textContent="";
  render();
},{passive:false});

undoBtn.onclick=()=>{
  selected.fill(false);
  msg.textContent="";
  render();
};

submitBtn.onclick=()=>{
  if(sameSet(userPts(),ANSWER_POINTS)){
    msg.textContent="Success";
    submitBtn.disabled=true;
    undoBtn.disabled=true;

    setTimeout(()=>{
      location.href=NEXT_URL;
    },REDIRECT_DELAY);
  }else{
    msg.textContent="Please try again";
  }
};

render();
</script>
</body>
</html>

