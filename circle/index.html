<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circle Puzzle</title>

  <style>
    :root{
      --maxw: 720px;

      --fs-body: 18px;
      --lh-body: 1.6;

      --fs-hint: 18px;
      --lh-hint: 1.6;
      --fw-hint: 700; /* ✅ 新增：与规范一致 */

      --fs-btn: 18px;
      --fw-btn: 600;
      --h-btn: 52px;

      --gap: 18px;
      --gap-tight: 12px;

      --c-text:#111;
      --c-border:#000;
      --c-ok:#0b6b2b;
    }

    html,body{
      margin:0;
      background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
                   "PingFang SC","Microsoft YaHei",Arial,sans-serif;
      font-size:var(--fs-body);
      line-height:var(--lh-body);
      color:var(--c-text);
    }

    .wrap{
      max-width:var(--maxw);
      margin:0 auto;
      padding:12px;
      box-sizing:border-box;
    }

    /* ===== 顶部说明文字（按 Rotate 的 titleLine 规范） ===== */
    .title{
      font-size: var(--fs-hint);
      line-height: var(--lh-hint);
      font-weight: var(--fw-hint);

      margin: 4px 0 var(--gap);

      text-align: left;
      white-space: pre-wrap;
    }

    .stage{
      width:100%;
      aspect-ratio:918/1024;
      overflow:hidden;
      user-select:none;
      touch-action:manipulation;
    }
    svg{ width:100%; height:100%; display:block; }

    .hit{ fill:transparent; pointer-events:none; }
    .dot{ fill:transparent; pointer-events:none; }
    .hit.selected + .dot{ fill:rgba(220,0,0,.92); }

    .panel{
      margin-top:var(--gap);
      display:flex;
      gap:var(--gap-tight);
      justify-content:center;
    }

    /* startgame 风格按钮 */
    button{
      width:240px;
      height:var(--h-btn);
      padding:0 18px;
      font-size:var(--fs-btn);
      font-weight:var(--fw-btn);
      background:#fff;
      color:#000;
      border:2px solid var(--c-border);
      cursor:pointer;
      border-radius:0;
      -webkit-tap-highlight-color:transparent;
    }

    /* PC hover */
    @media (hover:hover) and (pointer:fine){
      button:hover{ background:#000; color:#fff; }
    }

    /* JS 控制的点击反馈（与 square 一致） */
    button.invert{
      background:#000;
      color:#fff;
    }

    button:disabled{ opacity:.45; cursor:default; }

    .msg{
      margin-top:var(--gap-tight);
      min-height:1.4em;
      font-size:14px;
    }

    /* 成功提示样式（与 square 一致：绿色 + 加粗） */
    .msg.ok{
      color:var(--c-ok);
      font-weight:700;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="title">
    走到天平路41号马路正对面的行人道上，面向天平路康平路路口方向，留意50米范围内的墙面信息，进行答题。点击正确位置的圆圈后提交答案。
  </div>

  <div class="stage">
    <svg viewBox="0 0 918 1024" id="svg"
         xmlns="http://www.w3.org/2000/svg">
      <image href="map.png" x="0" y="0" width="918" height="1024"
             style="pointer-events:none;"></image>
      <rect id="catcher" x="0" y="0" width="918" height="1024"
            fill="transparent"></rect>
    </svg>
  </div>

  <div class="panel">
    <button id="hintBtn">获得提示</button>
    <button id="submitBtn">提交答案</button>
  </div>

  <div class="msg" id="msg"></div>
</div>

<script>
/* ===== 数据 ===== */
const CIRCLES = [
{"x":678,"y":84},{"x":752,"y":88},{"x":376,"y":166},{"x":473,"y":196},
{"x":553,"y":171},{"x":657,"y":219},{"x":307,"y":263},{"x":886,"y":187},
{"x":444,"y":247},{"x":115,"y":274},{"x":256,"y":209},{"x":806,"y":211},
{"x":879,"y":318},{"x":217,"y":346},{"x":303,"y":346},{"x":547,"y":349},
{"x":267,"y":638},{"x":105,"y":346},{"x":78,"y":434},{"x":56,"y":541},
{"x":189,"y":548},{"x":164,"y":460},{"x":585,"y":491},{"x":438,"y":491},
{"x":369,"y":579},{"x":813,"y":847},{"x":274,"y":550},{"x":485,"y":431},
{"x":617,"y":305},{"x":608,"y":617},{"x":535,"y":573},{"x":839,"y":590},
{"x":825,"y":659},{"x":897,"y":421},{"x":390,"y":673},{"x":303,"y":718},
{"x":527,"y":663},{"x":486,"y":728},{"x":862,"y":744},{"x":730,"y":172},
{"x":644,"y":827},{"x":506,"y":865},{"x":433,"y":878},{"x":332,"y":893},
{"x":206,"y":774},{"x":186,"y":622}
];

const ANSWER_POINTS = [
  {x:376,y:166},{x:217,y:346},{x:303,y:346},
  {x:78,y:434},{x:274,y:550},{x:825,y:659},
  {x:303,y:718},{x:644,y:827},{x:433,y:878}
];

const HINT_URL = "https://sorcbear.github.io/playground/circle/hint";
const NEXT_URL = "https://sorcbear.github.io/playground/track/";
const COUNTDOWN_START = 3;

const R_DOT=10, SNAP_DIST=36, EPS=10;

/* ===== 状态 ===== */
const svg = document.getElementById("svg");
const catcher = document.getElementById("catcher");
const submitBtn = document.getElementById("submitBtn");
const hintBtn = document.getElementById("hintBtn");
const msg = document.getElementById("msg");

const selected = new Array(CIRCLES.length).fill(false);
let locked=false;
let countdownTimer=null;
let btnTimer=null;

/* ===== 工具 ===== */
function el(n,a={}){const e=document.createElementNS("http://www.w3.org/2000/svg",n);for(const k in a)e.setAttribute(k,a[k]);return e;}
function svgPt(ev){const p=svg.createSVGPoint();p.x=ev.clientX;p.y=ev.clientY;return p.matrixTransform(svg.getScreenCTM().inverse());}
function d2(a,b){const dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy;}
function nearest(x,y){
  let bi=-1,bd=1e9;
  CIRCLES.forEach((c,i)=>{
    const dd=(x-c.x)**2+(y-c.y)**2;
    if(dd<bd){bd=dd;bi=i;}
  });
  return bd<=SNAP_DIST*SNAP_DIST?bi:-1;
}
function sameSet(u,a){
  if(u.length!==a.length)return false;
  const used=new Array(u.length).fill(false);
  for(const p of a){
    let ok=false;
    for(let i=0;i<u.length;i++){
      if(!used[i]&&d2(p,u[i])<=EPS*EPS){
        used[i]=true; ok=true; break;
      }
    }
    if(!ok)return false;
  }
  return true;
}
function userPts(){return selected.map((v,i)=>v?CIRCLES[i]:null).filter(Boolean);}

function render(){
  svg.querySelectorAll(".hit,.dot").forEach(n=>n.remove());
  CIRCLES.forEach((c,i)=>{
    const h=el("circle",{cx:c.x,cy:c.y,r:20});
    h.classList.add("hit");
    if(selected[i])h.classList.add("selected");
    const d=el("circle",{cx:c.x,cy:c.y,r:R_DOT});
    d.classList.add("dot");
    svg.insertBefore(h,catcher);
    svg.insertBefore(d,catcher);
  });
}

/* ===== 复用 square 的按钮逻辑（不动其他部分） ===== */

/* 公共：短暂黑底白字反馈（square 一致） */
function flashInvert(btn, ms=120){
  btn.classList.add("invert");
  setTimeout(()=>btn.classList.remove("invert"), ms);
}

function setLocked(v){
  locked=v;
  submitBtn.disabled=v;
  hintBtn.disabled=v;
}

/* 错误提示用（square 一致） */
function setBtnText(text, ms=900){
  if (btnTimer){ clearTimeout(btnTimer); btnTimer=null; }

  submitBtn.textContent = text;
  submitBtn.classList.add("invert");
  submitBtn.disabled = true;

  btnTimer = setTimeout(()=>{
    submitBtn.textContent = "提交答案";
    submitBtn.classList.remove("invert");
    submitBtn.disabled = false;
    btnTimer = null;
  }, ms);
}

/* ===== 事件 ===== */
catcher.addEventListener("pointerdown",e=>{
  if(locked) return;
  const p=svgPt(e);
  const i=nearest(p.x,p.y);
  if(i<0) return;
  selected[i]=!selected[i];
  render();
},{passive:false});

/* 获得提示：先反馈，再跳转（square 一致） */
hintBtn.onclick = ()=>{
  if (locked) return;
  flashInvert(hintBtn, 120);
  setTimeout(()=>location.href = HINT_URL, 120);
};

submitBtn.onclick=()=>{
  if(locked) return;

  if(sameSet(userPts(),ANSWER_POINTS)){
    setLocked(true);

    let t=COUNTDOWN_START;
    msg.textContent=`答案正确，即将进入下一题（${t}）`;
    msg.classList.add("ok");

    countdownTimer=setInterval(()=>{
      t--;
      if(t>0){
        msg.textContent=`答案正确，即将进入下一题（${t}）`;
      }else{
        clearInterval(countdownTimer);
        location.href=NEXT_URL;
      }
    },1000);
  }else{
    msg.textContent="";
    msg.classList.remove("ok");
    setBtnText("不正确，再试一次",900);
  }
};

render();
</script>
</body>
</html>
