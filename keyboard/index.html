<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Piano Puzzle</title>

<style>
html,body{
  margin:0;
  background:#fff;
  color:#111;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:6px 8px;
  box-sizing:border-box;
}
.topbar{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:4px;
}
.status{
  font-size:14px;
  min-height:18px;
  flex:1 1 240px;
}
.btns{display:flex;gap:8px;}
button{
  border:none;
  border-radius:10px;
  background:#111;
  color:#fff;
  padding:8px 10px;
  font-size:14px;
}
.ok{background:#12b76a;font-weight:700;color:#052;}
.hint{font-size:14px;margin-bottom:6px;}
.small{font-size:12px;opacity:.7;}

.kbd{
  position:relative;
  width:100%;
  overflow:hidden;
  background:#fff;
  touch-action:none;
}
.kbd::before{content:"";display:block;padding-top:34%;}
.kbd-inner{
  position:absolute;inset:0;
  display:flex;
  align-items:flex-start;
  justify-content:center;
}
#kbdImg{
  width:100%;
  height:100%;
  object-fit:contain;
  object-position:center top;
  pointer-events:none;
}

.overlay{position:absolute;inset:0;pointer-events:none;}
.seg{
  position:absolute;top:0;bottom:0;
  outline:1px solid rgba(0,160,90,.7);
  background:rgba(0,160,90,.06);
  display:none;
}
.debug .seg{display:block;}

.flash{
  position:absolute;
  top:55%;
  height:45%;
  background:rgba(0,0,0,.12);
  border-radius:10px;
  opacity:0;
  transition:opacity 80ms;
}
.flash.on{opacity:1;}

@media (orientation:landscape){
  .kbd::before{padding-top:26%;}
}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="status" id="status">未开始</div>
    <div class="btns">
      <button id="audioBtn" class="ok">启用声音</button>
      <button id="resetBtn">Reset</button>
      <button id="debugBtn">Debug</button>
    </div>
  </div>

  <div class="hint">
    建议横屏操作；相邻两次点击间隔 ≤ 5 秒。
    <div class="small">iPhone：需先点击“启用声音”。</div>
  </div>

  <div class="kbd" id="kbd">
    <div class="kbd-inner">
      <img id="kbdImg" src="./keyboard.png">
    </div>
    <div class="overlay" id="overlay"></div>
  </div>
</div>

<script>
(()=>{
/* ================= 固定配置 ================= */
const KEY_COUNT = 12;
const OFFSET = 2; // 最左是 green si
const MAX_GAP = 5;

/* ================ 键映射 ================= */
const KEYS = [
  ["green","so",55],["green","la",57],["green","si",59],
  ["red","do",60],["red","re",62],["red","mi",64],["red","fa",65],
  ["red","so",67],["red","la",69],["red","si",71],
  ["blue","do",72],["blue","re",74],["blue","mi",76],["blue","fa",77],
  ["blue","so",79],["blue","la",81]
];

const TARGET = [
  ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
  ["red","do"],["red","re"],["red","la"],["blue","re"],["blue","fa"],["red","la"],["blue","re"],["blue","fa"],
  ["green","si"],["red","re"],["red","so"],["blue","re"],["blue","fa"],["red","so"],["blue","re"],["blue","fa"],
  ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"]
];

/* ================ DOM ================= */
const img=document.getElementById("kbdImg");
const kbd=document.getElementById("kbd");
const overlay=document.getElementById("overlay");
const statusEl=document.getElementById("status");

const audioBtn=document.getElementById("audioBtn");
const resetBtn=document.getElementById("resetBtn");
const debugBtn=document.getElementById("debugBtn");

/* ================ Audio ================= */
let ctx=null, audioOn=false;
async function enableAudio(){
  ctx ||= new (window.AudioContext||window.webkitAudioContext)();
  if(ctx.state==="suspended") await ctx.resume();
  audioOn=true;
}
function freq(m){return 440*Math.pow(2,(m-69)/12);}
function play(m){
  if(!audioOn) return;
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.type="sine";
  o.frequency.value=freq(m);
  g.gain.setValueAtTime(.0001,ctx.currentTime);
  g.gain.linearRampToValueAtTime(.3,ctx.currentTime+.02);
  g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+1.2);
  o.connect(g).connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime+1.25);
}

/* ================ 定位核心 ================= */
let bounds=null, segs=[], flash=null;

function detectBoundaries(){
  const iw=img.naturalWidth, ih=img.naturalHeight;
  const cvs=document.createElement("canvas");
  cvs.width=iw; cvs.height=ih;
  const c=cvs.getContext("2d",{willReadFrequently:true});
  c.drawImage(img,0,0);
  const y0=Math.floor(ih*0.66), y1=Math.floor(ih*0.9);
  const h=y1-y0;
  const d=c.getImageData(0,y0,iw,h).data;
  const col=new Float32Array(iw);
  for(let x=0;x<iw;x++){
    let s=0;
    for(let y=0;y<h;y++){
      const i=(y*iw+x)*4;
      if(d[i]<60 && d[i+1]<60 && d[i+2]<60) s++;
    }
    col[x]=s;
  }
  const base=[...col].sort((a,b)=>a-b)[iw>>1];
  for(let i=0;i<iw;i++) col[i]=Math.max(0,col[i]-base);

  const smooth=new Float32Array(iw);
  for(let x=0;x<iw;x++){
    let s=0,cnt=0;
    for(let k=-5;k<=5;k++){
      if(col[x+k]!=null){s+=col[x+k];cnt++;}
    }
    smooth[x]=s/cnt;
  }

  const peaks=[];
  const max=Math.max(...smooth);
  for(let x=2;x<iw-2;x++){
    if(smooth[x]>max*0.45 &&
       smooth[x]>=smooth[x-1] &&
       smooth[x]>=smooth[x+1]){
      peaks.push(x);
    }
  }

  const need=11;
  const chosen=[];
  const minDist=iw/(KEY_COUNT*1.1);
  for(const x of peaks){
    if(chosen.every(v=>Math.abs(v-x)>minDist)) chosen.push(x);
    if(chosen.length===need) break;
  }
  chosen.sort((a,b)=>a-b);

  const refined=chosen.map(x=>{
    let l=x,r=x;
    while(smooth[l]>smooth[x]*.5) l--;
    while(smooth[r]>smooth[x]*.5) r++;
    return Math.round((l+r)/2);
  });

  return [0,...refined,iw];
}

function layout(){
  overlay.innerHTML="";
  segs=[];
  const r=kbd.getBoundingClientRect();
  const iw=img.naturalWidth, ih=img.naturalHeight;
  const scale=Math.min(r.width/iw,r.height/ih);
  const dw=iw*scale;
  const pad=(r.width-dw)/2;
  for(let i=0;i<KEY_COUNT;i++){
    const s=document.createElement("div");
    s.className="seg";
    s.style.left=(bounds[i]/iw*dw+pad)+"px";
    s.style.width=((bounds[i+1]-bounds[i])/iw*dw)+"px";
    overlay.appendChild(s);
    segs.push(s);
  }
  flash=document.createElement("div");
  flash.className="flash";
  overlay.appendChild(flash);
}

function locate(x,y){
  const r=kbd.getBoundingClientRect();
  const iw=img.naturalWidth, ih=img.naturalHeight;
  const scale=Math.min(r.width/iw,r.height/ih);
  const dw=iw*scale, dh=ih*scale;
  const dx=(r.width-dw)/2;
  if(x<dx||x>dx+dw) return null;
  const nx=(x-dx)/dw*iw;
  for(let i=0;i<KEY_COUNT;i++){
    if(nx>=bounds[i]&&nx<bounds[i+1]) return i;
  }
  return null;
}

/* ================ 判定 ================= */
let step=0,lastT=null;
function reset(msg="未开始"){
  step=0; lastT=null;
  statusEl.textContent=msg;
}
function press(i){
  const g=i+OFFSET;
  flash.style.left=segs[i].style.left;
  flash.style.width=segs[i].style.width;
  flash.classList.add("on");
  setTimeout(()=>flash.classList.remove("on"),80);
  play(KEYS[g][2]);

  const now=performance.now()/1000;
  if(lastT&&now-lastT>MAX_GAP) return reset("已超时，请重新完整弹奏");
  lastT=now;

  const [c,n]=TARGET[step];
  const idx=KEYS.findIndex(k=>k[0]===c&&k[1]===n);
  if(g!==idx) return reset(`失败：应为 ${c}${n}`);
  step++;
  statusEl.textContent=step===TARGET.length?"success":`进度 ${step}/${TARGET.length}`;
}

/* ================ 事件 ================= */
kbd.addEventListener("pointerdown",e=>{
  const i=locate(e.clientX,e.clientY);
  if(i!=null) press(i);
},{passive:false});

audioBtn.onclick=async()=>{
  await enableAudio();
  audioBtn.textContent="声音已启用";
};
resetBtn.onclick=()=>reset("已重置");
debugBtn.onclick=()=>document.body.classList.toggle("debug");

img.onload=()=>{
  bounds=detectBoundaries();
  layout();
};
})();
</script>
</body>
</html>
