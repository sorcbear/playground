<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Piano Puzzle</title>

<style>
html,body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
  user-select:none;
}

.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:14px;
}

.hint{
  font-size:14px;
  opacity:.9;
  margin-bottom:10px;
}

.kbd{
  position:relative;
  width:100%;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.kbd::before{
  content:"";
  display:block;
  padding-top:45.1%;
}
.kbd-bg{
  position:absolute;
  inset:0;
  background:url("./keyboard.png") center/cover no-repeat;
}

/* 16 个白键点击区 */
.keys{
  position:absolute;
  inset:0;
  display:flex;
}
.key{
  flex:1;
}
.key.active{
  background:rgba(255,255,255,.08);
}

.panel{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.status{
  font-size:14px;
  min-height:22px;
}
button{
  border:none;
  border-radius:10px;
  background:#222;
  color:#fff;
  padding:10px 14px;
  font-size:14px;
}
button:active{transform:translateY(1px)}
</style>
</head>

<body>
<div class="wrap">
  <div class="hint">
    按正确顺序弹奏旋律，并保持节奏均匀（第1–2音间隔作为基准）。
  </div>

  <div class="kbd">
    <div class="kbd-bg"></div>
    <div class="keys" id="keys"></div>
  </div>

  <div class="panel">
    <div class="status" id="status">未开始</div>
    <div>
      <button id="resetBtn">Reset</button>
    </div>
  </div>
</div>

<script>
/* =========================
   1. 键位定义（16 白键）
========================= */
const KEYS = [
  {c:"green",n:"so",m:55},
  {c:"green",n:"la",m:57},
  {c:"green",n:"si",m:59},

  {c:"red",n:"do",m:60},
  {c:"red",n:"re",m:62},
  {c:"red",n:"mi",m:64},
  {c:"red",n:"fa",m:65},
  {c:"red",n:"so",m:67},
  {c:"red",n:"la",m:69},
  {c:"red",n:"si",m:71},

  {c:"blue",n:"do",m:72},
  {c:"blue",n:"re",m:74},
  {c:"blue",n:"mi",m:76},
  {c:"blue",n:"fa",m:77},
  {c:"blue",n:"so",m:79},
  {c:"blue",n:"la",m:81},
];

const keyIndex = new Map();
KEYS.forEach((k,i)=>keyIndex.set(`${k.c}|${k.n}`,i));

/* =========================
   2. 正确答案（32 音）
========================= */
const target = [
  // A
  ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
  // B
  ["red","do"],["red","re"],["red","la"],["blue","re"],["blue","fa"],["red","la"],["blue","re"],["blue","fa"],
  // C
  ["green","si"],["red","re"],["red","so"],["blue","re"],["blue","fa"],["red","so"],["blue","re"],["blue","fa"],
  // D (=A)
  ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
];

/* =========================
   3. 节奏判定参数
========================= */
const ABS_TOL = 0.08;   // 80ms
const REL_TOL = 0.18;
const DT_MIN = 0.16;
const DT_MAX = 1.20;

/* =========================
   4. WebAudio（银色钢琴）
========================= */
let audioCtx=null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||webkitAudioContext)();
  }
  if(audioCtx.state==="suspended") return audioCtx.resume();
}

function midiToFreq(m){
  return 440*Math.pow(2,(m-69)/12);
}

function playTone(freq,duration=0.32){
  if(!audioCtx) return;
  const now=audioCtx.currentTime;

  const o1=audioCtx.createOscillator();
  const o2=audioCtx.createOscillator();
  const o3=audioCtx.createOscillator();

  o1.type="sine";
  o2.type="triangle";
  o3.type="square";

  o1.frequency.value=freq;
  o2.frequency.value=freq*2;
  o3.frequency.value=freq*4;

  const g=audioCtx.createGain();
  g.gain.setValueAtTime(0.0001,now);
  g.gain.linearRampToValueAtTime(0.32,now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,now+duration);

  const f=audioCtx.createBiquadFilter();
  f.type="lowpass";
  f.frequency.value=Math.min(freq*6,12000);

  o1.connect(g);o2.connect(g);o3.connect(g);
  g.connect(f);f.connect(audioCtx.destination);

  o1.start(now);o2.start(now);o3.start(now);
  o1.stop(now+duration+0.03);
  o2.stop(now+duration+0.03);
  o3.stop(now+duration+0.03);
}

/* =========================
   5. UI & 判定
========================= */
const keysEl=document.getElementById("keys");
const statusEl=document.getElementById("status");
const resetBtn=document.getElementById("resetBtn");

let step=0,t1=null,t2=null,dt0=null,last=null;

function reset(msg="已重置"){
  step=0;t1=t2=dt0=last=null;
  statusEl.textContent=msg;
}

KEYS.forEach((k,i)=>{
  const d=document.createElement("div");
  d.className="key";
  d.onpointerdown=async e=>{
    e.preventDefault();
    await ensureAudio();
    press(i);
  };
  keysEl.appendChild(d);
});

function press(i){
  const k=KEYS[i];
  playTone(midiToFreq(k.m));
  const need=target[step];
  if(!need||i!==keyIndex.get(`${need[0]}|${need[1]}`)){
    reset("失败：音符错误");
    return;
  }

  const now=performance.now()/1000;

  if(step===0){t1=now;last=now;}
  else if(step===1){
    t2=now;dt0=t2-t1;
    if(dt0<DT_MIN||dt0>DT_MAX){reset("失败：节奏不合理");return;}
    last=now;
  }else{
    const dt=now-last;
    const tol=Math.max(ABS_TOL,dt0*REL_TOL);
    if(Math.abs(dt-dt0)>tol){reset("失败：节奏不均匀");return;}
    last=now;
  }

  step++;
  statusEl.textContent=`进度 ${step}/${target.length}`;

  if(step===target.length){
    statusEl.textContent="success";
  }
}

resetBtn.onclick=()=>reset("已重置");
reset("未开始");
</script>
</body>
</html>
