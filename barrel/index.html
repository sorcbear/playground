<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barrel Puzzle</title>
  <style>
    :root{
      --bg: #ffffff;
      --text: #111;
      --stroke: #0b0f2e;
      --fill: #243B8F;

      --cardMaxW: 340px;     /* 单张牌最大宽度 */
      --gap: 14px;

      --fadeMs: 260ms;       /* 切换渐进速度：越大越慢 */
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .wrap{
      width:min(1100px, 94vw);
      padding: 18px 0 22px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      align-items: stretch;
    }

    .card{
      position:relative;
      width: 100%;
      max-width: var(--cardMaxW);
      margin: 0 auto;
      aspect-ratio: 718 / 1024;
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 28px rgba(0,0,0,0.10);
    }

    /* 过渡层：用于淡入淡出 */
    .layer{
      position:absolute;
      inset:0;
      opacity: 1;
      transition: opacity var(--fadeMs) ease;
      will-change: opacity;
    }
    .layer.fading{
      opacity: 0;
    }

    .pattern{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    /* 数字层：改为描边，不用多重阴影，避免重影 */
    .digitWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }

    .digit{
      font-family: "Cinzel", "Times New Roman", Georgia, serif;
      /* 放大：你可以继续加大，比如把最大值从 230px 调到 260px */
      font-size: clamp(130px, 16vw, 230px);
      line-height: 1;
      letter-spacing: 0.01em;

      color: var(--fill);
      -webkit-text-stroke: 6px var(--stroke);
      paint-order: stroke fill;

      /* 轻微立体感（单一阴影，不会产生重影） */
      text-shadow: 0 5px 0 rgba(0,0,0,0.12);

      user-select:none;
    }

    .hint{
      margin: 14px auto 10px;
      text-align:center;
      font-size: 14px;
      opacity: 0.78;
    }

    .buttons{
      display:flex;
      gap: 22px;
      justify-content:center;
      align-items:center;
      margin-top: 10px;
    }

    .coinBtn{
      width: 78px;
      height: 78px;
      border:none;
      background: transparent;
      padding:0;
      cursor:pointer;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.14);
    }
    .coinBtn:disabled{
      cursor:not-allowed;
      opacity: 0.55;
      box-shadow:none;
    }
    .coinBtn img{
      width:100%;
      height:100%;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .status{
      margin-top: 12px;
      text-align:center;
      min-height: 22px;
      font-weight: 600;
    }

    @media (max-width: 820px){
      .cards{ grid-template-columns: 1fr; }
      .card{ max-width: min(94vw, 440px); }
      .coinBtn{ width: 74px; height: 74px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="cards">

      <!-- Card 1 -->
      <div class="card">
        <div class="layer" id="layer1">
          <img class="pattern" id="pat1" alt="pattern-1">
          <div class="digitWrap">
            <div class="digit" id="dig1">1</div>
          </div>
        </div>
      </div>

      <!-- Card 2 -->
      <div class="card">
        <div class="layer" id="layer2">
          <img class="pattern" id="pat2" alt="pattern-2">
          <div class="digitWrap">
            <div class="digit" id="dig2">5</div>
          </div>
        </div>
      </div>

      <!-- Card 3 -->
      <div class="card">
        <div class="layer" id="layer3">
          <img class="pattern" id="pat3" alt="pattern-3">
          <div class="digitWrap">
            <div class="digit" id="dig3">7</div>
          </div>
        </div>
      </div>

    </div>

    <div class="hint">点击下方金币切换上方牌面，组合正确后显示 success。</div>

    <div class="buttons">
      <button class="coinBtn" id="btn1" aria-label="按钮1">
        <img src="coin.png" alt="coin">
      </button>
      <button class="coinBtn" id="btn2" aria-label="按钮2">
        <img src="coin.png" alt="coin">
      </button>
      <button class="coinBtn" id="btn3" aria-label="按钮3">
        <img src="coin.png" alt="coin">
      </button>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script>
    // ====== 资源 ======
    const patterns = ["p0.png", "p1.png", "p2.png", "p3.png"]; // 4 张图案

    // ====== 状态 ======
    // 数字：1..9 循环；图案：0..3 循环
    let D = [1, 5, 7];     // D1 D2 D3
    let P = [2, 1, 1];     // P1 P2 P3

    // 目标（你可改）
    const targetD = [4, 7, 2];
    const targetP = [0, 2, 3]; // A=0,B=1,C=2,D=3

    // ====== DOM ======
    const digEls = [document.getElementById("dig1"), document.getElementById("dig2"), document.getElementById("dig3")];
    const patEls = [document.getElementById("pat1"), document.getElementById("pat2"), document.getElementById("pat3")];
    const layerEls = [document.getElementById("layer1"), document.getElementById("layer2"), document.getElementById("layer3")];
    const statusEl = document.getElementById("status");

    const btnEls = [null, document.getElementById("btn1"), document.getElementById("btn2"), document.getElementById("btn3")];

    function incDigit(x){ return (x % 9) + 1; }
    function incPattern(x){ return (x + 1) % patterns.length; }

    // ====== 按钮规则（保持你之前那套“交叉 + 纠偏”）======
    function pressButton(k){
      // 防止疯狂连点导致过渡被打断
      disableButtons(true);

      if(k === 1){
        D[0] = incDigit(D[0]);
        P[1] = incPattern(P[1]);
      }else if(k === 2){
        P[0] = incPattern(P[0]);
        D[1] = incDigit(D[1]);
        D[2] = incDigit(D[2]);
      }else if(k === 3){
        D[2] = incDigit(D[2]);
        P[1] = incPattern(P[1]);
        P[2] = incPattern(P[2]);
      }

      renderWithFade().then(() => {
        checkWin();
        disableButtons(false);
      });
    }

    function disableButtons(disabled){
      for(let i=1;i<=3;i++){
        btnEls[i].disabled = disabled;
      }
    }

    // ====== 渐进切换：先淡出 -> 换内容 -> 淡入 ======
    function renderWithFade(){
      const fadeMs = getFadeMs();

      // 1) 淡出
      layerEls.forEach(el => el.classList.add("fading"));

      return new Promise((resolve) => {
        // 2) 等淡出结束后换内容，再淡入
        window.setTimeout(() => {
          renderImmediate();
          // 触发回流，确保淡入生效
          void document.body.offsetHeight;
          layerEls.forEach(el => el.classList.remove("fading"));

          // 3) 等淡入结束
          window.setTimeout(() => resolve(), fadeMs);
        }, fadeMs);
      });
    }

    function getFadeMs(){
      // 从 CSS 变量读取（不写死）
      const v = getComputedStyle(document.documentElement).getPropertyValue("--fadeMs").trim();
      const n = parseInt(v.replace("ms",""), 10);
      return Number.isFinite(n) ? n : 260;
    }

    function renderImmediate(){
      for(let i=0;i<3;i++){
        digEls[i].textContent = String(D[i]);
        patEls[i].src = patterns[P[i]];
      }
      statusEl.textContent = "";
    }

    function isWin(){
      for(let i=0;i<3;i++){
        if(D[i] !== targetD[i]) return false;
        if(P[i] !== targetP[i]) return false;
      }
      return true;
    }

    function checkWin(){
      if(isWin()){
        statusEl.textContent = "success";
        // 成功后跳转下一关（需要就开启并改路径）
        // window.location.href = "../nextpage/";
      }
    }

    // 绑定按钮
    document.getElementById("btn1").addEventListener("click", ()=>pressButton(1));
    document.getElementById("btn2").addEventListener("click", ()=>pressButton(2));
    document.getElementById("btn3").addEventListener("click", ()=>pressButton(3));

    // 初次渲染
    renderImmediate();
  </script>
</body>
</html>
