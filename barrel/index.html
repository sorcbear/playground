<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barrel Puzzle</title>
  <style>
    :root{
      --bg: #ffffff;
      --text: #111;
      --stroke: #0b0f2e;
      --fill: #243B8F;

      --cardMaxW: 340px;
      --gap: 14px;

      /* 翻页速度（越大越慢） */
      --flipMs: 340ms;

      /* 按钮大小（你要求小一点） */
      --btnSize: 62px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .wrap{
      width:min(1100px, 94vw);
      padding: 18px 0 22px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--gap);
      align-items: stretch;
    }

    .card{
      position:relative;
      width: 100%;
      max-width: var(--cardMaxW);
      margin: 0 auto;
      aspect-ratio: 718 / 1024;
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 28px rgba(0,0,0,0.10);

      /* 3D 透视，为翻页服务 */
      perspective: 1000px;
    }

    /* 牌面内容层：真正做翻页的是它 */
    .face{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      backface-visibility: hidden;

      /* 默认状态 */
      transform: rotateY(0deg);
      transition: transform var(--flipMs) ease-in-out;
      will-change: transform;
    }

    /* 翻到一半（看不见正面内容），此时换图换字不会闪 */
    .face.flipOut{
      transform: rotateY(90deg);
    }
    /* 换完内容后翻回来 */
    .face.flipIn{
      transform: rotateY(0deg);
    }

    .pattern{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .digitWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }

    /* 数字：再放大，并用描边避免重影 */
    .digit{
      font-family: "Cinzel", "Times New Roman", Georgia, serif;
      /* 更大：你如果还要更大，把最大值 280px 改到 320px */
      font-size: clamp(150px, 18.5vw, 280px);
      line-height: 1;
      letter-spacing: 0.01em;

      color: var(--fill);
      -webkit-text-stroke: 7px var(--stroke);
      paint-order: stroke fill;

      /* 单一阴影，避免“重影感” */
      text-shadow: 0 6px 0 rgba(0,0,0,0.12);
      user-select:none;
    }

    .hint{
      margin: 14px auto 10px;
      text-align:center;
      font-size: 14px;
      opacity: 0.78;
    }

    .buttons{
      display:flex;
      gap: 18px;
      justify-content:center;
      align-items:center;
      margin-top: 10px;
    }

    .coinBtn{
      width: var(--btnSize);
      height: var(--btnSize);
      border:none;
      background: transparent;
      padding:0;
      cursor:pointer;
      border-radius: 999px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.14);
    }
    .coinBtn:disabled{
      cursor:not-allowed;
      opacity: 0.55;
      box-shadow:none;
    }
    .coinBtn img{
      width:100%;
      height:100%;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .status{
      margin-top: 12px;
      text-align:center;
      min-height: 22px;
      font-weight: 600;
    }

    @media (max-width: 820px){
      .cards{ grid-template-columns: 1fr; }
      .card{ max-width: min(94vw, 440px); }
      :root{ --btnSize: 58px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="cards">

      <div class="card">
        <div class="face" id="face1">
          <img class="pattern" id="pat1" alt="pattern-1">
          <div class="digitWrap"><div class="digit" id="dig1">1</div></div>
        </div>
      </div>

      <div class="card">
        <div class="face" id="face2">
          <img class="pattern" id="pat2" alt="pattern-2">
          <div class="digitWrap"><div class="digit" id="dig2">5</div></div>
        </div>
      </div>

      <div class="card">
        <div class="face" id="face3">
          <img class="pattern" id="pat3" alt="pattern-3">
          <div class="digitWrap"><div class="digit" id="dig3">7</div></div>
        </div>
      </div>

    </div>

    <div class="hint">点击下方金币切换上方牌面，组合正确后显示 success。</div>

    <div class="buttons">
      <button class="coinBtn" id="btn1" aria-label="按钮1"><img src="coin.png" alt="coin"></button>
      <button class="coinBtn" id="btn2" aria-label="按钮2"><img src="coin.png" alt="coin"></button>
      <button class="coinBtn" id="btn3" aria-label="按钮3"><img src="coin.png" alt="coin"></button>
    </div>

    <div class="status" id="status"></div>
  </div>

  <script>
    // 4 张图案（按顺序循环）
    const patterns = ["p0.png", "p1.png", "p2.png", "p3.png"];

    // 数字：1..9 循环；图案：0..3 循环
    let D = [1, 5, 7];
    let P = [2, 1, 1];

    // 目标（你可改）
    const targetD = [4, 7, 2];
    const targetP = [0, 2, 3]; // A=0,B=1,C=2,D=3

    const digEls  = [document.getElementById("dig1"), document.getElementById("dig2"), document.getElementById("dig3")];
    const patEls  = [document.getElementById("pat1"), document.getElementById("pat2"), document.getElementById("pat3")];
    const faceEls = [document.getElementById("face1"), document.getElementById("face2"), document.getElementById("face3")];
    const statusEl = document.getElementById("status");

    const btn1 = document.getElementById("btn1");
    const btn2 = document.getElementById("btn2");
    const btn3 = document.getElementById("btn3");

    function incDigit(x){ return (x % 9) + 1; }
    function incPattern(x){ return (x + 1) % patterns.length; }

    // 按钮规则（保持之前那套）
    function applyRule(k){
      if(k === 1){
        D[0] = incDigit(D[0]);
        P[1] = incPattern(P[1]);
      }else if(k === 2){
        P[0] = incPattern(P[0]);
        D[1] = incDigit(D[1]);
        D[2] = incDigit(D[2]);
      }else if(k === 3){
        D[2] = incDigit(D[2]);
        P[1] = incPattern(P[1]);
        P[2] = incPattern(P[2]);
      }
    }

    function renderImmediate(){
      for(let i=0;i<3;i++){
        digEls[i].textContent = String(D[i]);
        patEls[i].src = patterns[P[i]];
      }
      statusEl.textContent = "";
    }

    function isWin(){
      for(let i=0;i<3;i++){
        if(D[i] !== targetD[i]) return false;
        if(P[i] !== targetP[i]) return false;
      }
      return true;
    }

    function checkWin(){
      if(isWin()){
        statusEl.textContent = "success";
        // window.location.href = "../nextpage/";
      }
    }

    function setButtonsDisabled(disabled){
      btn1.disabled = disabled;
      btn2.disabled = disabled;
      btn3.disabled = disabled;
    }

    // 翻页切换：先 flipOut -> 换内容 -> flipIn
    async function pressButton(k){
      setButtonsDisabled(true);

      // 1) 先翻到 90 度
      faceEls.forEach(el => {
        el.classList.remove("flipIn");
        el.classList.add("flipOut");
      });

      const flipMs = getFlipMs();
      await sleep(flipMs);

      // 2) 在“看不见内容”的瞬间换状态（不会闪）
      applyRule(k);
      renderImmediate();

      // 3) 翻回来
      faceEls.forEach(el => {
        el.classList.remove("flipOut");
        el.classList.add("flipIn");
      });

      await sleep(flipMs);

      checkWin();
      setButtonsDisabled(false);
    }

    function getFlipMs(){
      const v = getComputedStyle(document.documentElement).getPropertyValue("--flipMs").trim();
      const n = parseInt(v.replace("ms",""), 10);
      return Number.isFinite(n) ? n : 340;
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    btn1.addEventListener("click", ()=>pressButton(1));
    btn2.addEventListener("click", ()=>pressButton(2));
    btn3.addEventListener("click", ()=>pressButton(3));

    // 首次渲染
    renderImmediate();
  </script>
</body>
</html>
