<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Start Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --maxw: 720px;

      --fs-body: 16px;
      --lh-body: 1.7;

      --fs-hint: 18px;
      --lh-hint: 1.6;

      --fs-status: 18px;
      --fw-status: 700;

      --ctl-h: 48px;
      --w-mainbtn: 240px;

      --gap: 18px;

      --c-text: #111;
      --c-border: #000;
    }

    html, body{
      margin:0; padding:0;
      width:100%; height:100%;
      background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      font-size:var(--fs-body);
      line-height:var(--lh-body);
      color:var(--c-text);
    }
    button{ font-family: inherit; }

    .container{
      width:100%; height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:var(--gap);
      padding:18px;
      box-sizing:border-box;
      text-align:center;
    }

    /* 初始不占位，按钮更“真居中” */
    .hint,
    .status{
      display:none;
      width:min(var(--maxw), 92vw);
      user-select:none;
      margin:0;
      white-space:pre-wrap;
    }

    .hint{
      font-size:var(--fs-hint);
      line-height:var(--lh-hint);
    }

    .status{
      font-size:var(--fs-status);
      font-weight:var(--fw-status);
      line-height:1.4;
    }

    button{
      width:var(--w-mainbtn);
      height:var(--ctl-h);
      padding:0 18px;
      box-sizing:border-box;
      font-size:var(--fs-body);
      font-weight:600;
      background:#fff;
      color:#000;
      border:2px solid var(--c-border);
      cursor:pointer;
      border-radius:0;
    }
    button:hover{ background:#000; color:#fff; }
    button:disabled{ opacity:.45; cursor:default; }

    @media (max-width: 420px){
      :root{
        --w-mainbtn: 220px;
        --ctl-h: 46px;
        --fs-hint: 17px;
        --fs-status: 17px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="hint" id="hint"></div>
    <div class="status" id="status"></div>
    <button id="startBtn">开始游戏</button>
  </div>

<script>
(() => {
  // =====================================================
  // ① 取消 gate：允许直接访问 start.html
  //    但保留 reset 与进度记录（其它不变）
  // =====================================================
  const PASS_KEY = "playground_pass";
  const PASS_VER_KEY = "playground_ver";
  const LAST_KEY = "playground_last_page";

  const BASE = "/playground";
  const INDEX_URL = BASE + "/";
  const NEXT_URL  = BASE + "/rotate/";

  // reset=1：清除通行证/版本/进度（调试 / 回收）
  const params = new URLSearchParams(location.search);
  if (params.get("reset") === "1") {
    localStorage.removeItem(PASS_KEY);
    localStorage.removeItem(PASS_VER_KEY);
    localStorage.removeItem(LAST_KEY);
    location.replace(INDEX_URL);
    return;
  }

  // ✅ 方案1：进入 start 就记录进度为 start（不需要验证也照样记录）
  localStorage.setItem(LAST_KEY, BASE + "/start.html");

  // =====================================================
  // ② 游戏开始逻辑（保持不变）
  // =====================================================
  const NOTE_GAP_SEC = 0.25;
  const NOTE_DUR_SEC = 0.22;
  const COUNTDOWN_SEC = 10;

  const KEYS = [
    {c:"green",n:"so",m:55},
    {c:"green",n:"la",m:57},
    {c:"green",n:"si",m:59},
    {c:"red",n:"do",m:60},
    {c:"red",n:"re",m:62},
    {c:"red",n:"mi",m:64},
    {c:"red",n:"fa",m:65},
    {c:"red",n:"so",m:67},
    {c:"red",n:"la",m:69},
    {c:"red",n:"si",m:71},
    {c:"blue",n:"do",m:72},
    {c:"blue",n:"re",m:74},
    {c:"blue",n:"mi",m:76},
    {c:"blue",n:"fa",m:77},
    {c:"blue",n:"so",m:79},
    {c:"blue",n:"la",m:81},
  ];

  const target = [
    ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
    ["red","do"],["red","re"],["red","la"],["blue","re"],["blue","fa"],["red","la"],["blue","re"],["blue","fa"],
    ["green","si"],["red","re"],["red","so"],["blue","re"],["blue","fa"],["red","so"],["blue","re"],["blue","fa"],
    ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
  ];

  function targetToMidiSeq(){
    return target.map(([tc,tn]) =>
      KEYS.find(k => k.c===tc && k.n===tn)?.m
    ).filter(Boolean);
  }
  const CORRECT_MIDI_SEQ = targetToMidiSeq();

  const hintEl = document.getElementById("hint");
  const statusEl = document.getElementById("status");
  const startBtn = document.getElementById("startBtn");

  // 初始不显示提示/状态，不占位
  hintEl.textContent = "";
  statusEl.textContent = "";
  hintEl.style.display = "none";
  statusEl.style.display = "none";

  let audioCtx = null;
  let audioEnabled = false;

  function ensureAudioCtx(){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(!audioCtx) audioCtx = new AC();
    return audioCtx;
  }

  async function enableAudio(){
    const ctx = ensureAudioCtx();
    if(ctx.state === "suspended") await ctx.resume();
    audioEnabled = true;
  }

  function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }

  function playTone(freq, duration){
    if(!audioEnabled || !audioCtx) return;
    const now = audioCtx.currentTime;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = "sine";
    o.frequency.setValueAtTime(freq, now);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.linearRampToValueAtTime(0.3, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

    o.connect(g);
    g.connect(audioCtx.destination);

    o.start(now);
    o.stop(now + duration + 0.05);
  }

  function playMelody(){
    CORRECT_MIDI_SEQ.forEach((midi, i) => {
      setTimeout(() => {
        playTone(midiToFreq(midi), NOTE_DUR_SEC);
      }, i * NOTE_GAP_SEC * 1000);
    });
  }

  let timers = [];
  function clearTimers(){
    timers.forEach(t => clearTimeout(t));
    timers = [];
  }

  function startCountdown(){
    let left = COUNTDOWN_SEC;
    const tick = () => {
      statusEl.textContent = `倒计时：${left}`;
      if(left <= 0){
        location.href = NEXT_URL;
        return;
      }
      left--;
      timers.push(setTimeout(tick, 1000));
    };
    tick();
  }

  async function startFlow(){
    startBtn.disabled = true;

    // 点击后再显示提示与倒计时区域
    hintEl.style.display = "block";
    statusEl.style.display = "block";

    hintEl.textContent = "好像听到一段诡异的音乐...";
    statusEl.textContent = "";

    clearTimers();
    try{ await enableAudio(); }catch(e){}

    playMelody();
    startCountdown();
  }

  startBtn.addEventListener("click", startFlow);
})();
</script>
</body>
</html>
