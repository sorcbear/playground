<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Start Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --maxw: 720px;

      --fs-body: 16px;
      --lh-body: 1.7;

      --fs-hint: 18px;
      --lh-hint: 1.6;

      --fs-status: 18px;
      --fw-status: 700;

      --ctl-h: 48px;
      --w-mainbtn: 240px;

      --gap: 18px;
      --space-action: 64px;

      --c-text:#111;
      --c-border:#000;
      --c-danger:#b00020;
    }

    html,body{
      margin:0;
      width:100%;
      height:100%;
      background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:var(--fs-body);
      line-height:var(--lh-body);
      color:var(--c-text);
    }

    .container{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:18px;
      box-sizing:border-box;
    }

    .centerStack{
      display:none;
      width:min(var(--maxw),92vw);
    }

    /* ===== 通用标题样式（来自 Rotate 页面，已验证） ===== */
    .title{
      font-size: var(--fs-hint);      /* 18px */
      line-height: var(--lh-hint);    /* 1.6 */
      font-weight: 700;               /* 粗标题 */
      margin: 4px 0 var(--gap);       /* 与下一个元素隔 1 行 */
      text-align: left;
      white-space: pre-wrap;
    }

    /* 倒计时标题（红色） */
    .title-danger{
      color: var(--c-danger);
      margin: 0;                      /* 不再额外制造空行 */
      text-align: left;
    }

    .btnRow{
      margin-top:var(--space-action);
    }

    button{
      width:var(--w-mainbtn);
      height:var(--ctl-h);
      font-size:16px;
      font-weight:600;
      background:#fff;
      color:#000;
      border:2px solid var(--c-border);
      cursor:pointer;
    }
    button:hover{ background:#000; color:#fff; }
    button:disabled{ opacity:.45; cursor:default; }
  </style>
</head>

<body>
<div class="container">

  <div class="centerStack" id="centerStack">
    <div class="title" id="hint">
      好像听到一段诡异的音乐...
    </div>
    <div class="title title-danger" id="status"></div>
  </div>

  <div class="btnRow" id="btnRow">
    <button id="startBtn">开始游戏</button>
  </div>

</div>

<script>
(() => {
  const NEXT_URL = "/playground/rotate/";
  const COUNTDOWN_SEC = 10;

  const NOTE_GAP_SEC = 0.25;
  const NOTE_DUR_SEC = 0.22;

  const KEYS = [
    {c:"green",n:"so",m:55},{c:"green",n:"la",m:57},{c:"green",n:"si",m:59},
    {c:"red",n:"do",m:60},{c:"red",n:"re",m:62},{c:"red",n:"mi",m:64},
    {c:"red",n:"fa",m:65},{c:"red",n:"so",m:67},{c:"red",n:"la",m:69},{c:"red",n:"si",m:71},
    {c:"blue",n:"do",m:72},{c:"blue",n:"re",m:74},{c:"blue",n:"mi",m:76},
    {c:"blue",n:"fa",m:77},{c:"blue",n:"so",m:79},{c:"blue",n:"la",m:81},
  ];

  const target = [
    ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
    ["red","do"],["red","re"],["red","la"],["blue","re"],["blue","fa"],["red","la"],["blue","re"],["blue","fa"],
    ["green","si"],["red","re"],["red","so"],["blue","re"],["blue","fa"],["red","so"],["blue","re"],["blue","fa"],
    ["red","do"],["red","mi"],["red","so"],["blue","do"],["blue","mi"],["red","so"],["blue","do"],["blue","mi"],
  ];

  const melody = target
    .map(([c,n]) => KEYS.find(k => k.c===c && k.n===n)?.m)
    .filter(Boolean);

  const centerStack = document.getElementById("centerStack");
  const statusEl = document.getElementById("status");
  const btnRow = document.getElementById("btnRow");
  const startBtn = document.getElementById("startBtn");

  let audioCtx, audioEnabled=false, musicPlayed=false;
  let timers=[];

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
    return audioCtx;
  }

  async function enableAudio(){
    const ctx = ensureAudio();
    if(ctx.state==="suspended") await ctx.resume();
    audioEnabled=true;
  }

  function playTone(freq,d){
    if(!audioEnabled) return;
    const t=audioCtx.currentTime;
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.frequency.value=freq;
    g.gain.setValueAtTime(0.001,t);
    g.gain.linearRampToValueAtTime(0.3,t+0.02);
    g.gain.exponentialRampToValueAtTime(0.001,t+d);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t); o.stop(t+d+0.05);
  }

  function playMelody(){
    melody.forEach((m,i)=>{
      setTimeout(
        ()=>playTone(440*Math.pow(2,(m-69)/12),NOTE_DUR_SEC),
        i*NOTE_GAP_SEC*1000
      );
    });
  }

  function clearTimers(){
    timers.forEach(clearTimeout);
    timers=[];
  }

  function startCountdown(){
    let left = COUNTDOWN_SEC;
    const tick = ()=>{
      statusEl.textContent = `倒计时：${left}`;

      if(left === 8 && !musicPlayed){
        musicPlayed = true;
        playMelody();
      }

      if(left <= 0){
        location.href = NEXT_URL;
        return;
      }
      left--;
      timers.push(setTimeout(tick,1000));
    };
    tick();
  }

  async function startFlow(){
    startBtn.disabled=true;
    btnRow.style.display="none";
    centerStack.style.display="block";

    clearTimers();
    try{ await enableAudio(); }catch(e){}
    startCountdown();
  }

  startBtn.addEventListener("click",startFlow);
})();
</script>
</body>
</html>
